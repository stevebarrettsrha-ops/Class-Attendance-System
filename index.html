<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CESTIS - Student Attendance Tracking System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Google API for Drive Integration -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <!-- TOTP/2FA Libraries for Google Authenticator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.2.2/otpauth.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ============================================
           CESTIS Student Attendance System
           Professional Modern Design v2.0
           ============================================ */

        /* CSS Reset & Base */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ============================================
           CSS Custom Properties (Design Tokens)
           ============================================ */
        :root {
            /* Primary Brand Colors */
            --primary: #1e3a5f;
            --primary-light: #2d5a87;
            --primary-dark: #132740;
            --primary-50: rgba(30, 58, 95, 0.05);
            --primary-100: rgba(30, 58, 95, 0.1);
            --primary-200: rgba(30, 58, 95, 0.2);

            /* Accent Colors */
            --accent: #0ea5e9;
            --accent-light: #38bdf8;
            --accent-dark: #0284c7;

            /* Success/Green */
            --success: #059669;
            --success-light: #10b981;
            --success-dark: #047857;
            --success-bg: #ecfdf5;
            --success-border: #a7f3d0;

            /* Warning/Amber */
            --warning: #d97706;
            --warning-light: #f59e0b;
            --warning-dark: #b45309;
            --warning-bg: #fffbeb;
            --warning-border: #fde68a;

            /* Danger/Red */
            --danger: #dc2626;
            --danger-light: #ef4444;
            --danger-dark: #b91c1c;
            --danger-bg: #fef2f2;
            --danger-border: #fecaca;

            /* Info/Blue */
            --info: #0891b2;
            --info-light: #22d3ee;
            --info-bg: #ecfeff;
            --info-border: #a5f3fc;

            /* Neutral Colors */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Background & Surface */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;

            /* Text Colors */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --text-inverse: #ffffff;

            /* Border Colors */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-dark: #94a3b8;

            /* Shadow System */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;

            /* Spacing Scale */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Font Families */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            --font-mono: 'Fira Code', 'Consolas', 'Monaco', monospace;
        }

        /* ============================================
           Dark Mode Theme
           ============================================ */
        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;

            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;

            --border-light: #334155;
            --border-medium: #475569;
            --border-dark: #64748b;

            --primary-50: rgba(56, 189, 248, 0.05);
            --primary-100: rgba(56, 189, 248, 0.1);
            --primary-200: rgba(56, 189, 248, 0.2);

            --success-bg: rgba(5, 150, 105, 0.15);
            --warning-bg: rgba(217, 119, 6, 0.15);
            --danger-bg: rgba(220, 38, 38, 0.15);
            --info-bg: rgba(8, 145, 178, 0.15);

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           Base Styles
           ============================================ */
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* ============================================
           Login Page
           ============================================ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--accent-dark) 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 80%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(5, 150, 105, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            padding: var(--space-10);
            width: 100%;
            max-width: 440px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            border: 1px solid var(--border-light);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .login-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-2);
            letter-spacing: -0.025em;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: var(--space-1);
            line-height: 1.5;
        }

        .input-group {
            margin-bottom: var(--space-5);
        }

        .input-group label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .login-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            transition: all var(--transition-normal);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .login-input:hover {
            border-color: var(--border-medium);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .login-btn {
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 4px 20px rgba(30, 58, 95, 0.3);
        }

        .login-btn:hover::before {
            opacity: 1;
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background: var(--danger-bg);
            color: var(--danger);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
            font-size: 0.875rem;
            display: none;
            border-left: 4px solid var(--danger);
            animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* ============================================
           Header
           ============================================ */
        .header {
            background: var(--primary);
            padding: var(--space-5) var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            border-radius: var(--radius-xl);
            border: 1px solid var(--primary-dark);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
        }

        .header-title {
            text-align: center;
            flex: 1;
        }

        .header-title h1 {
            color: var(--text-inverse);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .tagline {
            color: var(--success-light);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            margin-top: var(--space-1);
        }

        /* ============================================
           Quick Actions
           ============================================ */
        .quick-actions {
            background: var(--bg-secondary);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            border: 1px solid var(--border-light);
        }

        .quick-actions h3 {
            color: var(--text-primary);
            margin-bottom: var(--space-5);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .action-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 2px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .action-card:hover {
            border-color: var(--primary-200);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-card-icon {
            font-size: 2.25rem;
            margin-bottom: var(--space-3);
            display: block;
        }

        .action-card-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        /* ============================================
           Navigation Tabs
           ============================================ */
        .nav-tabs {
            display: flex;
            gap: var(--space-1);
            margin-bottom: var(--space-6);
            background: var(--bg-secondary);
            padding: var(--space-2);
            border-radius: var(--radius-xl);
            flex-wrap: wrap;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .nav-tab {
            padding: var(--space-3) var(--space-5);
            background: transparent;
            border: none;
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition-normal);
            position: relative;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .nav-tab.active {
            color: var(--text-inverse);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: var(--shadow-sm);
        }

        /* ============================================
           Modules
           ============================================ */
        .module {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .module.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           Buttons
           ============================================ */
        .btn {
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text-inverse);
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(30, 58, 95, 0.25);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: var(--text-inverse);
        }

        .btn-success:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(5, 150, 105, 0.25);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
            color: var(--text-inverse);
        }

        .btn-warning:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(217, 119, 6, 0.25);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: var(--text-inverse);
        }

        .btn-danger:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(220, 38, 38, 0.25);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--text-inverse);
        }

        .btn-secondary:hover {
            background: var(--gray-600);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ============================================
           Form Sections
           ============================================ */
        .form-section {
            background: var(--bg-secondary);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            border: 1px solid var(--border-light);
        }

        .form-section h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--border-light);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-5);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9375rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-normal);
            font-family: var(--font-sans);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--border-medium);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ============================================
           Tables
           ============================================ */
        .table-container {
            background: var(--bg-secondary);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            margin-bottom: var(--space-6);
            border: 1px solid var(--border-light);
        }

        .table-container h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--space-5);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px;
        }

        th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text-inverse);
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            border-radius: var(--radius-md) 0 0 0;
        }

        th:last-child {
            border-radius: 0 var(--radius-md) 0 0;
        }

        td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-light);
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        tr {
            transition: background var(--transition-fast);
        }

        tbody tr:hover {
            background: var(--primary-50);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ============================================
           Badges
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success-border);
        }

        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid var(--warning-border);
        }

        .badge-danger {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger-border);
        }

        .badge-primary {
            background: var(--primary-100);
            color: var(--primary);
            border: 1px solid var(--primary-200);
        }

        .badge-info {
            background: var(--info-bg);
            color: var(--info);
            border: 1px solid var(--info-border);
        }

        /* ============================================
           Modals
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: var(--space-6);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            max-width: 640px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--border-light);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--border-light);
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-tertiary);
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .close-btn:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        /* ============================================
           Upload Section
           ============================================ */
        .upload-section {
            border: 2px dashed var(--border-medium);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            text-align: center;
            background: var(--bg-tertiary);
            margin-bottom: var(--space-4);
            transition: all var(--transition-normal);
        }

        .upload-section:hover {
            border-color: var(--accent);
            background: var(--primary-50);
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-label {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4) var(--space-6);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text-inverse);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-normal);
        }

        .upload-label:hover {
            box-shadow: var(--shadow-lg), 0 4px 20px rgba(30, 58, 95, 0.3);
            transform: translateY(-2px);
        }

        /* ============================================
           Control Buttons (Logout & Theme)
           ============================================ */
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: all var(--transition-normal);
        }

        .logout-btn:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(220, 38, 38, 0.25);
            transform: translateY(-1px);
        }

        .theme-toggle-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border-light);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: all var(--transition-normal);
        }

        .theme-toggle-btn:hover {
            border-color: var(--accent);
            background: var(--primary-50);
        }

        /* ============================================
           Cloud Sync Styles
           ============================================ */
        .cloud-sync-container {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .cloud-sync-btn {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: all var(--transition-normal);
            white-space: nowrap;
        }

        .cloud-sync-btn:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(66, 133, 244, 0.3);
            transform: translateY(-1px);
        }

        .cloud-sync-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .cloud-sync-btn.save-btn {
            background: linear-gradient(135deg, #34a853 0%, #0f9d58 100%);
        }

        .cloud-sync-btn.save-btn:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(52, 168, 83, 0.3);
        }

        .cloud-sync-btn.sync-btn {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
        }

        .cloud-sync-btn.sync-btn:hover {
            box-shadow: var(--shadow-md), 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .cloud-sync-btn.connect-btn {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 50%, #34a853 75%, #4285f4 100%);
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: 0.7rem;
            color: var(--text-primary);
            padding: var(--space-1) var(--space-2);
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-sm);
        }

        .cloud-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-400);
        }

        .cloud-status-dot.connected {
            background: var(--success);
            animation: pulse-green 2s infinite;
        }

        .cloud-status-dot.syncing {
            background: var(--warning);
            animation: pulse-orange 1s infinite;
        }

        .cloud-status-dot.error {
            background: var(--danger);
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(5, 150, 105, 0); }
        }

        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(217, 119, 6, 0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .cloud-dropdown {
            position: relative;
            display: inline-block;
        }

        .cloud-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: var(--space-2);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            padding: var(--space-2);
        }

        .cloud-dropdown-content.show {
            display: block;
        }

        .cloud-dropdown-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: background var(--transition-fast);
        }

        .cloud-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .cloud-dropdown-item.danger {
            color: var(--danger);
        }

        .cloud-dropdown-divider {
            height: 1px;
            background: var(--border-light);
            margin: var(--space-2) 0;
        }

        .last-sync-info {
            padding: var(--space-2) var(--space-3);
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-align: center;
        }

        .cloud-sharing-tips {
            padding: var(--space-2) var(--space-3);
            background: #fef3c7;
            border-radius: var(--radius-md);
            margin: var(--space-1) var(--space-2);
        }

        .cloud-sharing-tips-header {
            font-size: 0.7rem;
            color: #92400e;
            font-weight: 600;
        }

        .cloud-sharing-tips ul {
            font-size: 0.65rem;
            color: #78350f;
            margin: var(--space-1) 0 0 0;
            padding-left: 14px;
        }

        body.dark-mode .cloud-sharing-tips {
            background: rgba(251, 191, 36, 0.15);
        }

        body.dark-mode .cloud-sharing-tips-header {
            color: #fbbf24;
        }

        body.dark-mode .cloud-sharing-tips ul {
            color: #fcd34d;
        }

        /* ============================================
           Stats Cards
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-5);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: var(--space-5);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--success), var(--accent));
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        /* Stat Card Color Variants */
        .stat-card:nth-child(1)::before { background: linear-gradient(90deg, var(--success), var(--success-light)); }
        .stat-card:nth-child(2)::before { background: linear-gradient(90deg, var(--danger), var(--danger-light)); }
        .stat-card:nth-child(3)::before { background: linear-gradient(90deg, var(--warning), var(--warning-light)); }
        .stat-card:nth-child(4)::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card:nth-child(5)::before { background: linear-gradient(90deg, var(--info), var(--accent-light)); }

        /* ============================================
           Search Box
           ============================================ */
        .search-box {
            margin-bottom: var(--space-5);
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 0.9375rem;
            transition: all var(--transition-normal);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-box input:hover {
            border-color: var(--border-medium);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        /* ============================================
           Alerts
           ============================================ */
        .alert {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            border-left: 4px solid;
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .alert-success {
            background: var(--success-bg);
            border-color: var(--success);
            color: var(--success-dark);
        }

        .alert-warning {
            background: var(--warning-bg);
            border-color: var(--warning);
            color: var(--warning-dark);
        }

        .alert-danger {
            background: var(--danger-bg);
            border-color: var(--danger);
            color: var(--danger-dark);
        }

        .alert-info {
            background: var(--info-bg);
            border-color: var(--info);
            color: var(--info);
        }

        /* ============================================
           Student Card
           ============================================ */
        .student-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all var(--transition-normal);
        }

        .student-card:hover {
            border-color: var(--primary-200);
            box-shadow: var(--shadow-md);
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border-light);
        }

        .student-name {
            font-weight: 600;
            font-size: 1.0625rem;
            color: var(--primary);
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* ============================================
           Module Headers
           ============================================ */
        .module h2 {
            color: var(--text-primary);
            font-size: 1.375rem;
            font-weight: 700;
            margin-bottom: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* ============================================
           Time Input
           ============================================ */
        input[type="time"] {
            padding: var(--space-3);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            transition: all var(--transition-normal);
        }

        input[type="time"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        /* ============================================
           Responsive Design
           ============================================ */
        @media (max-width: 1024px) {
            .container {
                padding: var(--space-4);
            }
        }

        @media (max-width: 768px) {
            .header-top {
                flex-wrap: wrap;
                gap: var(--space-3);
            }

            .header-title {
                order: -1;
                flex-basis: 100%;
                margin-bottom: var(--space-3);
            }

            .header-title h1 {
                font-size: 1.25rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                padding: var(--space-1);
            }

            .nav-tab {
                padding: var(--space-2) var(--space-3);
                font-size: 0.75rem;
            }

            table {
                font-size: 0.8125rem;
            }

            th, td {
                padding: var(--space-3);
            }

            .modal-content {
                padding: var(--space-5);
                margin: var(--space-4);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .login-box {
                padding: var(--space-6);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .btn {
                padding: var(--space-2) var(--space-4);
                font-size: 0.8125rem;
            }
        }

        /* ============================================
           Scrollbar Styling
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* ============================================
           Focus States for Accessibility
           ============================================ */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ============================================
           Print Styles - Enhanced for Reports
           ============================================ */
        @media print {
            /* Hide non-essential elements */
            .header, .nav-tabs, .quick-actions, .logout-btn, .theme-toggle-btn,
            .form-section, .btn:not(.print-visible), #loginPage, .modal,
            .alert, .close-btn, [onclick*="delete"], [onclick*="edit"] {
                display: none !important;
            }

            /* Reset page setup */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                color: black !important;
                font-size: 11pt !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Page margins */
            @page {
                margin: 1.5cm;
                size: A4 landscape;
            }

            /* Container adjustments */
            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .module {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background: white !important;
            }

            /* Report results visible */
            #reportResults {
                display: block !important;
            }

            /* Print header for reports */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20pt;
                padding-bottom: 10pt;
                border-bottom: 2pt solid #1e3a5f;
            }

            .print-header h1 {
                font-size: 18pt !important;
                color: #1e3a5f !important;
                margin-bottom: 5pt !important;
            }

            .print-header p {
                font-size: 10pt !important;
                color: #666 !important;
                margin: 2pt 0 !important;
            }

            /* Stats grid for print */
            .stats-grid {
                display: flex !important;
                justify-content: space-around !important;
                margin-bottom: 15pt !important;
                gap: 10pt !important;
                flex-wrap: wrap !important;
            }

            .stat-card {
                background: #f8f9fa !important;
                border: 1pt solid #ddd !important;
                padding: 8pt 15pt !important;
                border-radius: 4pt !important;
                text-align: center !important;
                box-shadow: none !important;
                flex: 1 1 auto !important;
                min-width: 100pt !important;
            }

            .stat-card .stat-label {
                font-size: 8pt !important;
                color: #666 !important;
                text-transform: uppercase !important;
                margin-bottom: 3pt !important;
            }

            .stat-card .stat-value {
                font-size: 16pt !important;
                font-weight: bold !important;
                color: #1e3a5f !important;
            }

            /* Table styles for print */
            .table-container {
                overflow: visible !important;
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            .table-container h3 {
                font-size: 12pt !important;
                margin-bottom: 8pt !important;
                color: #333 !important;
            }

            table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 9pt !important;
                page-break-inside: auto !important;
            }

            thead {
                display: table-header-group !important;
            }

            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            th {
                background: #1e3a5f !important;
                color: white !important;
                padding: 8pt 6pt !important;
                text-align: left !important;
                font-weight: 600 !important;
                border: 1pt solid #1e3a5f !important;
                font-size: 9pt !important;
            }

            td {
                padding: 6pt !important;
                border: 1pt solid #ddd !important;
                color: #333 !important;
                vertical-align: middle !important;
            }

            tbody tr:nth-child(even) {
                background: #f9f9f9 !important;
            }

            /* Status badges for print */
            .badge {
                padding: 2pt 6pt !important;
                border-radius: 3pt !important;
                font-size: 8pt !important;
                font-weight: 600 !important;
            }

            .badge.present, .badge-success {
                background: #d4edda !important;
                color: #155724 !important;
                border: 1pt solid #c3e6cb !important;
            }

            .badge.absent, .badge-danger {
                background: #f8d7da !important;
                color: #721c24 !important;
                border: 1pt solid #f5c6cb !important;
            }

            .badge.late, .badge-warning {
                background: #fff3cd !important;
                color: #856404 !important;
                border: 1pt solid #ffeeba !important;
            }

            /* Print footer */
            .print-footer {
                display: block !important;
                margin-top: 20pt;
                padding-top: 10pt;
                border-top: 1pt solid #ddd;
                font-size: 8pt;
                color: #666;
                text-align: center;
            }

            /* Hide print-only elements by default, show only when printing */
            .print-only {
                display: block !important;
            }
        }

        /* Hide print-only elements on screen */
        .print-only {
            display: none;
        }

        .print-header {
            display: none;
        }

        .print-footer {
            display: none;
        }

        /* ============================================
           Two-Factor Authentication (2FA) Styles
           ============================================ */
        .twofa-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .twofa-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .twofa-modal-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .twofa-modal-header h2 {
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .twofa-modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .twofa-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .twofa-qr-container canvas,
        .twofa-qr-container img {
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }

        .twofa-secret-key {
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            border: 1px dashed var(--border-medium);
            word-break: break-all;
            text-align: center;
        }

        .twofa-secret-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .twofa-code-input {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            margin: var(--space-6) 0;
        }

        .twofa-code-input input {
            width: 45px;
            height: 55px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition-fast);
        }

        .twofa-code-input input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .twofa-single-input {
            width: 100%;
            padding: var(--space-4);
            text-align: center;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 8px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition-fast);
        }

        .twofa-single-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .twofa-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-6);
        }

        .twofa-actions button {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .twofa-btn-primary {
            background: var(--success);
            color: white;
            border: none;
        }

        .twofa-btn-primary:hover {
            background: var(--success-dark);
        }

        .twofa-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .twofa-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .twofa-btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .twofa-btn-danger:hover {
            background: var(--danger-dark);
        }

        .twofa-backup-codes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
            margin: var(--space-4) 0;
            padding: var(--space-4);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .twofa-backup-code {
            font-family: var(--font-mono);
            padding: var(--space-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .twofa-backup-code.used {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .twofa-warning {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--warning-dark);
        }

        .twofa-success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--success-dark);
        }

        .twofa-status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .twofa-status-badge.enabled {
            background: var(--success-bg);
            color: var(--success);
        }

        .twofa-status-badge.disabled {
            background: var(--gray-100);
            color: var(--gray-500);
        }

        .twofa-setup-btn {
            padding: var(--space-2) var(--space-4);
            font-size: 0.85rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .twofa-login-step {
            text-align: center;
        }

        .twofa-login-step .login-subtitle {
            margin-bottom: var(--space-4);
        }

        .twofa-use-backup {
            margin-top: var(--space-4);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .twofa-use-backup a {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        .twofa-use-backup a:hover {
            color: var(--accent-dark);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1 class="login-title">CESTIS Attendance</h1>
                <p class="login-subtitle">Community Educational and Skills Training Institute</p>
                <p class="login-subtitle">and Services Limited</p>
                <p class="login-subtitle" style="margin-top: 1rem; font-weight: 600;">Student Attendance System</p>
            </div>

            <div class="login-error" id="loginError"></div>

            <!-- Step 1: Username/Password -->
            <div id="loginStep1">
                <form onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" class="login-input" required autocomplete="username">
                    </div>

                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" class="login-input" required autocomplete="current-password">
                    </div>

                    <button type="submit" class="login-btn"> Login</button>
                </form>
            </div>

            <!-- Step 2: 2FA Verification -->
            <div id="loginStep2FA" style="display: none;" class="twofa-login-step">
                <p class="login-subtitle">Enter the 6-digit code from your authenticator app</p>

                <div class="input-group">
                    <input type="text" id="login2FACode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
                </div>

                <button type="button" class="login-btn" onclick="verify2FALogin()">Verify Code</button>

                <div class="twofa-use-backup">
                    <a onclick="showBackupCodeInput()">Use a backup code instead</a>
                </div>

                <div id="backupCodeSection" style="display: none; margin-top: var(--space-4);">
                    <div class="input-group">
                        <label>Backup Code</label>
                        <input type="text" id="loginBackupCode" class="login-input" placeholder="Enter backup code" style="text-transform: uppercase; letter-spacing: 2px;">
                    </div>
                    <button type="button" class="login-btn" onclick="verifyBackupCodeLogin()" style="background: var(--warning);">Use Backup Code</button>
                </div>

                <button type="button" class="login-btn" onclick="cancelTwoFALogin()" style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border-medium); margin-top: var(--space-3);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" style="display: none;">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-top">
                    <button class="logout-btn" onclick="handleLogout()">
                        <span></span>
                        <span>Logout</span>
                    </button>

                    <div class="header-title">
                        <h1>CESTIS STUDENT ATTENDANCE SYSTEM</h1>
                        <div class="tagline">EMPOWERING COMMUNITIES</div>
                        <div class="subtitle">Track Student Attendance & Class Hours</div>
                    </div>

                    <div style="display: flex; align-items: center; gap: var(--space-4);">
                        <span id="currentUserDisplay" style="font-weight: 600; color: var(--text-inverse); font-size: 0.875rem;"></span>

                        <!-- Cloud Sync Controls -->
                        <div class="cloud-sync-container" id="cloudSyncContainer">
                            <div class="cloud-status" id="cloudStatus">
                                <span class="cloud-status-dot" id="cloudStatusDot"></span>
                                <span id="cloudStatusText">Not connected</span>
                            </div>

                            <div id="cloudNotConnected">
                                <button class="cloud-sync-btn connect-btn" onclick="connectToGoogleDrive()">
                                    <span></span>
                                    <span>Connect Drive</span>
                                </button>
                            </div>

                            <div id="cloudConnected" style="display: none;">
                                <div class="cloud-dropdown">
                                    <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
                                        <span id="cloudMenuIcon"></span>
                                        <span>Cloud</span>
                                        <span style="font-size: 0.6rem;"></span>
                                    </button>
                                    <div class="cloud-dropdown-content" id="cloudDropdownMenu">
                                        <div class="cloud-dropdown-item" onclick="saveToCloud()">
                                            <span></span>
                                            <span>Save to Cloud</span>
                                        </div>
                                        <div class="cloud-dropdown-item" onclick="syncFromCloud()">
                                            <span></span>
                                            <span>Sync from Cloud</span>
                                        </div>
                                        <div class="cloud-dropdown-divider"></div>
                                        <div class="last-sync-info" id="lastSyncInfo">
                                            Last sync: Never
                                        </div>
                                        <div class="last-sync-info" id="lastSavedByInfo" style="color: #6b7280; font-size: 0.7rem;">
                                            Last saved by: --
                                        </div>
                                        <div class="cloud-dropdown-divider"></div>
                                        <div class="cloud-sharing-tips">
                                            <div class="cloud-sharing-tips-header"> Shared Cloud Tips</div>
                                            <ul>
                                                <li>Always sync before making changes</li>
                                                <li>Coordinate saves with other users</li>
                                                <li>Last save overwrites previous data</li>
                                            </ul>
                                        </div>
                                        <div class="cloud-dropdown-divider"></div>
                                        <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
                                            <span></span>
                                            <span>Disconnect</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="theme-toggle-btn" onclick="toggleDarkMode()">
                            <span id="themeIcon"></span>
                            <span id="themeText">Dark</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions (Teacher View) -->
            <div id="teacherQuickActions" class="quick-actions" style="display: none;">
                <h3> Quick Actions</h3>
                <div class="action-grid">
                    <div class="action-card" onclick="switchModule('markAttendance')">
                        <div class="action-card-icon"></div>
                        <div class="action-card-title">Mark Attendance</div>
                    </div>
                    <div class="action-card" onclick="switchModule('todayAttendance')">
                        <div class="action-card-icon"></div>
                        <div class="action-card-title">Today's Records</div>
                    </div>
                    <div class="action-card" onclick="switchModule('viewHistory')">
                        <div class="action-card-icon"></div>
                        <div class="action-card-title">View History</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchModule('markAttendance')"> Mark Attendance</button>
                <button class="nav-tab" onclick="switchModule('todayAttendance')"> Today's Attendance</button>
                <button class="nav-tab" onclick="switchModule('viewHistory')"> Attendance History</button>
                <button class="nav-tab" id="skillsTab" style="display: none;" onclick="switchModule('skills')"> Skills Management</button>
                <button class="nav-tab" id="classManagementTab" style="display: none;" onclick="switchModule('classManagement')"> Class Management</button>
                <button class="nav-tab" id="reportsTab" style="display: none;" onclick="switchModule('reports')"> Reports</button>
                <button class="nav-tab" id="usersTab" style="display: none;" onclick="switchModule('users')"> Users</button>
            </div>

            <!-- Mark Attendance Module -->
            <div id="markAttendance" class="module active">
                <h2> Mark Student Attendance</h2>

                <div class="form-section">
                    <h3>Select Class</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Skill Type / Class *</label>
                            <select id="attendanceClassSelect" onchange="loadStudentsForAttendance()">
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="attendanceDate">
                        </div>
                    </div>
                </div>

                <div id="attendanceStudentsList" style="display: none;">
                    <h3 style="color: var(--primary); margin-bottom: var(--space-4);">Students in Class</h3>
                    <div id="studentsForAttendance"></div>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-success" onclick="saveAllAttendance()"> Save All Attendance Records</button>
                    </div>
                </div>
            </div>

            <!-- Today's Attendance Module -->
            <div id="todayAttendance" class="module">
                <h2> Today's Attendance Records</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Present</div>
                        <div class="stat-value" id="todayPresentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Absent</div>
                        <div class="stat-value" id="todayAbsentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Late</div>
                        <div class="stat-value" id="todayLateCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Records</div>
                        <div class="stat-value" id="todayTotalCount">0</div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label>Filter by Class</label>
                        <select id="todayFilterClass" onchange="renderTodayAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Class/Skill</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Break</th>
                                <th>Status</th>
                                <th>Net Hours</th>
                            </tr>
                        </thead>
                        <tbody id="todayAttendanceTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-secondary);">No attendance records for today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- View History Module -->
            <div id="viewHistory" class="module">
                <h2> Attendance History</h2>

                <!-- Month/Year Navigation -->
                <div class="form-section" style="margin-bottom: var(--space-4);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-4); flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="navigateHistoryMonth(-1)" style="padding: var(--space-2) var(--space-4);">
                             Previous
                        </button>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <select id="historyMonth" onchange="updateHistoryView()" style="padding: var(--space-2) var(--space-3); font-size: 1rem; min-width: 140px;">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="historyYear" onchange="updateHistoryView()" style="padding: var(--space-2) var(--space-3); font-size: 1rem; min-width: 100px;">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="navigateHistoryMonth(1)" style="padding: var(--space-2) var(--space-4);">
                            Next 
                        </button>
                        <button class="btn btn-primary" onclick="goToCurrentMonth()" style="padding: var(--space-2) var(--space-4);">
                             Current Month
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" id="historyStudentSearch" placeholder="Search student name..." onkeyup="updateHistoryView()">
                        </div>
                        <div class="form-group">
                            <label>Class/Skill</label>
                            <select id="historyClassFilter" onchange="updateHistoryView()">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div id="historyStats" style="margin-top: var(--space-4); padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                        <!-- Stats will be populated dynamically -->
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student Name</th>
                                <th>Class/Skill</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Break (min)</th>
                                <th>Status</th>
                                <th>Net Hours</th>
                                <th id="historyActionsHeader" style="display: none;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr>
                                <td colspan="9" style="text-align: center; color: var(--text-secondary);">Use filters to search attendance history</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Skills Management Module (Admin) -->
            <div id="skills" class="module">
                <h2> Skills Management</h2>
                
                <div class="alert alert-info">
                    <strong> Info:</strong> Define skill types/courses with detailed information. These skills will appear as dropdown options when marking attendance and adding students.
                </div>

                <!-- Add New Skill -->
                <div class="form-section">
                    <h3> Add New Skill Type</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Skill Name *</label>
                            <input type="text" id="newSkillName" placeholder="e.g., Carpentry, Plumbing, Electrical">
                        </div>
                        <div class="form-group">
                            <label>Skill Code</label>
                            <input type="text" id="newSkillCode" placeholder="e.g., CARP-001">
                        </div>
                        <div class="form-group">
                            <label>Duration (Weeks)</label>
                            <input type="number" id="newSkillDuration" placeholder="e.g., 12" min="1">
                        </div>
                        <div class="form-group">
                            <label>Instructor</label>
                            <input type="text" id="newSkillInstructor" placeholder="Instructor name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="newSkillDescription" rows="3" placeholder="Brief description of the skill/course"></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Start Time (Default)</label>
                            <input type="time" id="newSkillStartTime" value="08:00">
                        </div>
                        <div class="form-group">
                            <label>End Time (Default)</label>
                            <input type="time" id="newSkillEndTime" value="16:00">
                        </div>
                        <div class="form-group">
                            <label>Break Time (minutes)</label>
                            <input type="number" id="newSkillBreakTime" value="30" min="0">
                        </div>
                        <div class="form-group">
                            <label>Max Students</label>
                            <input type="number" id="newSkillMaxStudents" placeholder="e.g., 20" min="1">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addSkill()"> Add Skill Type</button>
                </div>

                <!-- Skills List -->
                <div class="table-container">
                    <h3>All Skill Types</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Skill Code</th>
                                <th>Skill Name</th>
                                <th>Duration</th>
                                <th>Instructor</th>
                                <th>Schedule</th>
                                <th>Max Students</th>
                                <th>Current Enrolled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="skillsTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-secondary);">No skills defined yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Class Management Module (Admin) -->
            <div id="classManagement" class="module">
                <h2> Class Management</h2>

                <!-- Upload Enrollment Register -->
                <div class="form-section">
                    <h3> Upload Enrollment Register</h3>
                    <div class="alert alert-info">
                        <strong> Info:</strong> Upload an Excel file (.xlsx) containing student enrollment data. 
                        Required columns: Student Name, Registration Number, Skill Type/Class
                    </div>
                    <div class="upload-section">
                        <input type="file" id="enrollmentFileUpload" accept=".xlsx, .xls" onchange="handleEnrollmentUpload(event)">
                        <label for="enrollmentFileUpload" class="upload-label">
                             Choose Excel File
                        </label>
                        <p style="margin-top: var(--space-4); color: var(--text-secondary); font-size: 0.875rem;">
                            Click to select enrollment register file
                        </p>
                    </div>
                </div>

                <!-- Manual Student Entry -->
                <div class="form-section">
                    <h3> Add Student Manually</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Student Name *</label>
                            <input type="text" id="newStudentName" placeholder="Full Name">
                        </div>
                        <div class="form-group">
                            <label>Registration Number *</label>
                            <input type="text" id="newStudentRegNo" placeholder="REG-001">
                        </div>
                        <div class="form-group">
                            <label>Skill Type / Class *</label>
                            <select id="newStudentClass">
                                <option value="">-- Select Skill --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Contact Number</label>
                            <input type="tel" id="newStudentContact" placeholder="+1234567890">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addStudentManually()"> Add Student</button>
                </div>

                <!-- Students List -->
                <div class="table-container">
                    <h3>All Enrolled Students</h3>
                    <div class="search-box">
                        <input type="text" id="studentSearchBox" placeholder=" Search students..." onkeyup="filterStudentsTable()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Registration No.</th>
                                <th>Student Name</th>
                                <th>Class/Skill</th>
                                <th>Contact</th>
                                <th>Enrollment Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-secondary);">No students enrolled yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Module (Admin) -->
            <div id="reports" class="module">
                <h2> Attendance Reports</h2>

                <div class="form-section">
                    <h3>Generate Report</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: 0.9rem;">
                        Use multiple filters together to narrow down your report results. All filters can be combined.
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="reportType">
                                <option value="all">All Records</option>
                                <option value="class">By Class</option>
                                <option value="student">By Student</option>
                                <option value="date">By Date Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Class/Skill</label>
                            <select id="reportClassSelect">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" id="reportStudentFilter" placeholder="Search by name...">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="reportStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="Present">Present Only</option>
                                <option value="Absent">Absent Only</option>
                                <option value="Late">Late Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-4); margin-top: var(--space-4); flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generateReport()"> Generate Report</button>
                        <button class="btn btn-secondary" onclick="clearReportFilters()"> Clear Filters</button>
                    </div>
                </div>

                <div id="reportResults" style="display: none;">
                    <!-- Print Header (visible only when printing) -->
                    <div class="print-header print-only">
                        <h1>CESTIS Attendance Report</h1>
                        <p>Community Educational and Skills Training Institute and Services Limited</p>
                        <p id="printReportDate"></p>
                        <p id="printReportFilters"></p>
                    </div>

                    <div class="stats-grid" id="reportStats"></div>
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); flex-wrap: wrap; gap: var(--space-4);">
                            <h3 style="margin-bottom: 0;">Report Results <span id="reportRecordCount" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                            <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="exportReportToExcel()"> Excel</button>
                                <button class="btn btn-info" onclick="exportReportToPDF()"> PDF</button>
                                <button class="btn btn-secondary" onclick="printReport()"> Print</button>
                            </div>
                        </div>
                        <table id="reportTable">
                            <thead id="reportTableHead"></thead>
                            <tbody id="reportTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Print Footer (visible only when printing) -->
                    <div class="print-footer print-only">
                        <p>Generated on: <span id="printGeneratedDate"></span> | CESTIS Student Attendance System</p>
                    </div>
                </div>
            </div>

            <!-- Users Module (Admin) -->
            <div id="users" class="module">
                <h2> User Management</h2>

                <div class="form-section">
                    <h3> Add New User</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="newUserName">
                        </div>
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="newUserUsername">
                        </div>
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" id="newUserPassword">
                        </div>
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="newUserRole">
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: var(--space-3);">
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="newUserForcePasswordChange" style="width: auto;">
                            <span>Require password change on first login</span>
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="addUser()"> Add User</button>
                </div>

                <div class="table-container">
                    <h3>All Users</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>2FA Status</th>
                                <th>Pwd Change</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>

                <!-- Current User 2FA Settings -->
                <div class="form-section" style="margin-top: var(--space-6);">
                    <h3>Your Two-Factor Authentication</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: 0.9rem;">
                        Protect your account with Google Authenticator or any TOTP-compatible app.
                    </p>
                    <div id="current2FAStatus">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="twofaSetupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Set Up Two-Factor Authentication</h2>
                <p>Scan the QR code with Google Authenticator or any TOTP app</p>
            </div>

            <div class="twofa-qr-container">
                <div id="twofaQRCode"></div>
                <div class="twofa-secret-label">Or enter this code manually:</div>
                <div class="twofa-secret-key" id="twofaSecretKey"></div>
            </div>

            <div class="twofa-warning">
                <strong>Important:</strong> Save the secret key in a safe place. You'll need it if you lose access to your authenticator app.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter the 6-digit code to verify setup:</label>
                <input type="text" id="twofaSetupCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFASetup()">Cancel</button>
                <button type="button" class="twofa-btn-primary" onclick="confirmTwoFASetup()">Enable 2FA</button>
            </div>
        </div>
    </div>

    <!-- 2FA Backup Codes Modal -->
    <div id="twofaBackupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Backup Codes</h2>
                <p>Save these codes in a secure location. Each code can only be used once.</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> These codes will only be shown once. Make sure to save them now!
            </div>

            <div class="twofa-backup-codes" id="twofaBackupCodes">
                <!-- Backup codes will be populated here -->
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="copyBackupCodes()">Copy Codes</button>
                <button type="button" class="twofa-btn-primary" onclick="closeBackupCodesModal()">I've Saved These Codes</button>
            </div>
        </div>
    </div>

    <!-- 2FA Disable Confirmation Modal -->
    <div id="twofaDisableModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Disable Two-Factor Authentication</h2>
                <p>Enter your current 2FA code to confirm</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> Disabling 2FA will make your account less secure.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter 6-digit code from your authenticator:</label>
                <input type="text" id="twofaDisableCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFADisable()">Cancel</button>
                <button type="button" class="twofa-btn-danger" onclick="confirmTwoFADisable()">Disable 2FA</button>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Edit Attendance Record</h2>
                <button class="close-btn" onclick="closeEditAttendanceModal()"></button>
            </div>

            <div class="alert alert-warning">
                <strong> Warning:</strong> Editing attendance records should be done carefully and documented.
            </div>

            <div class="form-group">
                <label>Student Name</label>
                <input type="text" id="editStudentName" disabled style="background: var(--bg-tertiary); cursor: not-allowed; opacity: 0.8;">
            </div>

            <div class="form-group">
                <label>Class/Skill</label>
                <input type="text" id="editClass" disabled style="background: var(--bg-tertiary); cursor: not-allowed; opacity: 0.8;">
            </div>

            <div class="form-group">
                <label>Date</label>
                <input type="date" id="editDate">
            </div>

            <div class="form-group">
                <label>Status</label>
                <select id="editStatus">
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                    <option value="Late">Late</option>
                </select>
            </div>

            <div class="form-group">
                <label>Time In</label>
                <input type="time" id="editTimeIn">
            </div>

            <div class="form-group">
                <label>Time Out</label>
                <input type="time" id="editTimeOut">
            </div>

            <div class="form-group">
                <label>Break Time (minutes)</label>
                <input type="number" id="editBreakTime" min="0" placeholder="0">
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="editNotes" rows="3"></textarea>
            </div>

            <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
                <button class="btn btn-success" onclick="saveAttendanceEdit()"> Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditAttendanceModal()"> Cancel</button>
            </div>
        </div>
    </div>

    <!-- View/Edit Skill Modal -->
    <div id="viewSkillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Skill Details</h2>
                <button class="close-btn" onclick="closeViewSkillModal()"></button>
            </div>

            <div class="form-group">
                <label>Skill Name *</label>
                <input type="text" id="viewSkillName">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Skill Code</label>
                    <input type="text" id="viewSkillCode">
                </div>
                <div class="form-group">
                    <label>Duration (Weeks)</label>
                    <input type="number" id="viewSkillDuration" min="1">
                </div>
                <div class="form-group">
                    <label>Instructor</label>
                    <input type="text" id="viewSkillInstructor">
                </div>
                <div class="form-group">
                    <label>Max Students</label>
                    <input type="number" id="viewSkillMaxStudents" min="1">
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="viewSkillDescription" rows="3"></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Start Time (Default)</label>
                    <input type="time" id="viewSkillStartTime">
                </div>
                <div class="form-group">
                    <label>End Time (Default)</label>
                    <input type="time" id="viewSkillEndTime">
                </div>
                <div class="form-group">
                    <label>Break Time (minutes)</label>
                    <input type="number" id="viewSkillBreakTime" min="0">
                </div>
            </div>

            <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
                <button class="btn btn-success" onclick="saveSkillEdit()"> Save Changes</button>
                <button class="btn btn-secondary" onclick="closeViewSkillModal()"> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Edit Student Details</h2>
                <button class="close-btn" onclick="closeEditStudentModal()"></button>
            </div>

            <div class="alert alert-info">
                <strong> Info:</strong> Editing student information will update all related attendance records.
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Student Name *</label>
                    <input type="text" id="editStudentNameInput" placeholder="Full Name">
                </div>
                <div class="form-group">
                    <label>Registration Number *</label>
                    <input type="text" id="editStudentRegNo" placeholder="REG-001">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Skill Type / Class *</label>
                    <select id="editStudentClass">
                        <option value="">-- Select Skill --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="tel" id="editStudentContact" placeholder="+1234567890">
                </div>
            </div>

            <div class="form-group">
                <label>Enrollment Date</label>
                <input type="date" id="editStudentEnrollmentDate">
            </div>

            <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
                <button class="btn btn-success" onclick="saveStudentEdit()"> Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditStudentModal()"> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Edit User</h2>
                <button class="close-btn" onclick="closeEditUserModal()"></button>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editUserFullName" placeholder="Full Name">
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="editUserUsername" placeholder="Username">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" id="editUserPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="editUserRole">
                        <option value="Teacher">Teacher</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top: var(--space-3);">
                <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                    <input type="checkbox" id="editUserForcePasswordChange" style="width: auto;">
                    <span>Require password change on next login</span>
                </label>
            </div>

            <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
                <button class="btn btn-success" onclick="saveUserEdit()"> Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditUserModal()"> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Force Password Change Modal -->
    <div id="forcePasswordChangeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Password Change Required</h2>
            </div>

            <div class="alert alert-warning">
                <strong> Notice:</strong> You must change your password before continuing.
            </div>

            <div class="form-group">
                <label>New Password *</label>
                <input type="password" id="forceNewPassword" placeholder="Enter new password">
            </div>

            <div class="form-group">
                <label>Confirm New Password *</label>
                <input type="password" id="forceConfirmPassword" placeholder="Confirm new password">
            </div>

            <div id="forcePasswordError" class="alert alert-danger" style="display: none;"></div>

            <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6);">
                <button class="btn btn-success" onclick="submitForcedPasswordChange()"> Change Password</button>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let users = [];
        let students = [];
        let attendanceRecords = [];
        let skills = [];
        let editingAttendanceIndex = null;
        let editingSkillIndex = null;
        let editingStudentIndex = null;
        let editingUserIndex = null;
        let pendingPasswordChangeUser = null;

        // Initialize default data
        function initializeDefaultData() {
            const savedUsers = localStorage.getItem('cestisAttendanceUsers');
            if (!savedUsers) {
                users = [{
                    id: 'USER001',
                    username: 'admin',
                    password: 'admin123',
                    fullName: 'System Administrator',
                    role: 'Admin',
                    createdDate: new Date().toISOString()
                }, {
                    id: 'USER002',
                    username: 'teacher',
                    password: 'teacher123',
                    fullName: 'Demo Teacher',
                    role: 'Teacher',
                    createdDate: new Date().toISOString()
                }];
                saveUsers();
            } else {
                users = JSON.parse(savedUsers);

                // Ensure admin user always exists with default credentials
                const adminUser = users.find(u => u.username === 'admin');
                if (!adminUser) {
                    users.unshift({
                        id: 'USER001',
                        username: 'admin',
                        password: 'admin123',
                        fullName: 'System Administrator',
                        role: 'Admin',
                        createdDate: new Date().toISOString()
                    });
                    saveUsers();
                }
            }

            const savedStudents = localStorage.getItem('cestisStudents');
            if (savedStudents) {
                students = JSON.parse(savedStudents);
            }

            const savedAttendance = localStorage.getItem('cestisAttendanceRecords');
            if (savedAttendance) {
                attendanceRecords = JSON.parse(savedAttendance);
            }

            const savedSkills = localStorage.getItem('cestisSkills');
            if (!savedSkills) {
                // Initialize with default skills
                skills = [
                    {
                        id: 'SKILL001',
                        name: 'Carpentry',
                        code: 'CARP-001',
                        duration: 12,
                        instructor: 'Mr. Johnson',
                        description: 'Basic to advanced carpentry skills including woodworking, furniture making, and construction',
                        startTime: '08:00',
                        endTime: '16:00',
                        breakTime: 30,
                        maxStudents: 20,
                        createdDate: new Date().toISOString()
                    },
                    {
                        id: 'SKILL002',
                        name: 'Plumbing',
                        code: 'PLUM-001',
                        duration: 10,
                        instructor: 'Ms. Williams',
                        description: 'Residential and commercial plumbing, pipe fitting, and maintenance',
                        startTime: '08:00',
                        endTime: '16:00',
                        breakTime: 30,
                        maxStudents: 15,
                        createdDate: new Date().toISOString()
                    },
                    {
                        id: 'SKILL003',
                        name: 'Electrical Installation',
                        code: 'ELEC-001',
                        duration: 14,
                        instructor: 'Mr. Brown',
                        description: 'Electrical wiring, installation, and repair for residential and commercial buildings',
                        startTime: '08:00',
                        endTime: '16:00',
                        breakTime: 30,
                        maxStudents: 18,
                        createdDate: new Date().toISOString()
                    }
                ];
                saveSkills();
            } else {
                skills = JSON.parse(savedSkills);
            }
        }

        // Save functions
        function saveUsers() {
            localStorage.setItem('cestisAttendanceUsers', JSON.stringify(users));
        }

        function saveStudents() {
            localStorage.setItem('cestisStudents', JSON.stringify(students));
        }

        function saveAttendanceRecords() {
            localStorage.setItem('cestisAttendanceRecords', JSON.stringify(attendanceRecords));
        }

        function saveSkills() {
            localStorage.setItem('cestisSkills', JSON.stringify(skills));
        }

        // Pending 2FA user (during login)
        let pendingTwoFAUser = null;

        // Login
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                // Check if 2FA is enabled for this user
                if (user.twoFactorEnabled && user.twoFactorSecret) {
                    // Store user temporarily and show 2FA verification
                    pendingTwoFAUser = user;
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2FA').style.display = 'block';
                    document.getElementById('login2FACode').value = '';
                    document.getElementById('login2FACode').focus();
                } else {
                    // No 2FA, proceed with login
                    completeLogin(user);
                }
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = ' Invalid credentials';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
            }
        }

        // Complete login after credentials (and 2FA if enabled) are verified
        function completeLogin(user) {
            // Check if user must change password
            if (user.forcePasswordChange) {
                pendingPasswordChangeUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('forcePasswordChangeModal').classList.add('active');
                document.getElementById('forceNewPassword').value = '';
                document.getElementById('forceConfirmPassword').value = '';
                document.getElementById('forcePasswordError').style.display = 'none';

                // Reset login form state
                pendingTwoFAUser = null;
                document.getElementById('loginStep1').style.display = 'block';
                document.getElementById('loginStep2FA').style.display = 'none';
                document.getElementById('backupCodeSection').style.display = 'none';
                return;
            }

            currentUser = user;
            sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(user));

            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = ` ${user.fullName} (${user.role})`;

            updateUIForRole();
            populateClassDropdowns();
            renderTodayAttendance();
            render2FAStatus();

            // Reset login form state
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
        }

        // Handle forced password change
        function submitForcedPasswordChange() {
            const newPassword = document.getElementById('forceNewPassword').value;
            const confirmPassword = document.getElementById('forceConfirmPassword').value;
            const errorDiv = document.getElementById('forcePasswordError');

            if (!newPassword || !confirmPassword) {
                errorDiv.textContent = ' Please fill in both password fields';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = ' Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = ' Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (!pendingPasswordChangeUser) {
                errorDiv.textContent = ' Session expired. Please login again.';
                errorDiv.style.display = 'block';
                return;
            }

            // Update user password and remove force flag
            const userIndex = users.findIndex(u => u.id === pendingPasswordChangeUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                users[userIndex].forcePasswordChange = false;
                saveUsers();

                // Close modal and complete login
                document.getElementById('forcePasswordChangeModal').classList.remove('active');
                const updatedUser = users[userIndex];
                pendingPasswordChangeUser = null;

                // Now complete the login
                currentUser = updatedUser;
                sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(updatedUser));

                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = ` ${updatedUser.fullName} (${updatedUser.role})`;

                updateUIForRole();
                populateClassDropdowns();
                renderTodayAttendance();
                render2FAStatus();

                alert(' Password changed successfully!');
            } else {
                errorDiv.textContent = ' User not found. Please login again.';
                errorDiv.style.display = 'block';
            }
        }

        // Verify 2FA code during login
        function verify2FALogin() {
            const code = document.getElementById('login2FACode').value.trim();

            if (!code || code.length !== 6) {
                showLoginError('Please enter a 6-digit code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Verify TOTP code
            if (verifyTOTPCode(pendingTwoFAUser.twoFactorSecret, code)) {
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid code. Please try again.');
                document.getElementById('login2FACode').value = '';
                document.getElementById('login2FACode').focus();
            }
        }

        // Verify backup code during login
        function verifyBackupCodeLogin() {
            const backupCode = document.getElementById('loginBackupCode').value.trim().toUpperCase();

            if (!backupCode) {
                showLoginError('Please enter a backup code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Check if backup code is valid and not used
            const codeIndex = pendingTwoFAUser.backupCodes ?
                pendingTwoFAUser.backupCodes.findIndex(bc => bc.code === backupCode && !bc.used) : -1;

            if (codeIndex !== -1) {
                // Mark backup code as used
                const userIndex = users.findIndex(u => u.id === pendingTwoFAUser.id);
                if (userIndex !== -1) {
                    users[userIndex].backupCodes[codeIndex].used = true;
                    saveUsers();
                    pendingTwoFAUser = users[userIndex];
                }
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid or already used backup code');
                document.getElementById('loginBackupCode').value = '';
                document.getElementById('loginBackupCode').focus();
            }
        }

        // Show backup code input
        function showBackupCodeInput() {
            document.getElementById('backupCodeSection').style.display = 'block';
        }

        // Cancel 2FA login and go back
        function cancelTwoFALogin() {
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('login2FACode').value = '';
            document.getElementById('loginBackupCode').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = ' ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }

        // Logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                pendingTwoFAUser = null;
                sessionStorage.removeItem('cestisAttendanceCurrentUser');

                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginStep1').style.display = 'block';
                document.getElementById('loginStep2FA').style.display = 'none';
                document.getElementById('backupCodeSection').style.display = 'none';
            }
        }

        // Update UI based on role
        function updateUIForRole() {
            if (currentUser.role === 'Admin') {
                document.getElementById('skillsTab').style.display = 'block';
                document.getElementById('classManagementTab').style.display = 'block';
                document.getElementById('reportsTab').style.display = 'block';
                document.getElementById('usersTab').style.display = 'block';
                document.getElementById('users').style.display = 'block';
                document.getElementById('historyActionsHeader').style.display = 'table-cell';
                renderSkillsTable();
                renderStudentsTable();
                renderUsersTable();
                populateSkillDropdowns();
                render2FAStatus();
            } else {
                // Hide admin-only tabs
                document.getElementById('skillsTab').style.display = 'none';
                document.getElementById('classManagementTab').style.display = 'none';
                document.getElementById('reportsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('users').style.display = 'none';
                document.getElementById('historyActionsHeader').style.display = 'none';
                document.getElementById('teacherQuickActions').style.display = 'block';
                populateSkillDropdowns();

                // Ensure teacher sees Mark Attendance module, not User Management
                document.querySelectorAll('.module').forEach(module => module.classList.remove('active'));
                document.getElementById('markAttendance').classList.add('active');
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.nav-tab[onclick*="markAttendance"]').classList.add('active');
            }
        }

        // Populate skill/class dropdowns
        function populateSkillDropdowns() {
            const dropdowns = [
                'attendanceClassSelect',
                'todayFilterClass',
                'historyClassFilter',
                'reportClassSelect',
                'newStudentClass'
            ];

            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                const currentValue = select.value;
                
                if (id === 'attendanceClassSelect' || id === 'newStudentClass') {
                    select.innerHTML = '<option value="">-- Select Skill --</option>';
                } else {
                    select.innerHTML = '<option value="">All Classes</option>';
                }
                
                skills.forEach(skill => {
                    const option = document.createElement('option');
                    option.value = skill.name;
                    option.textContent = `${skill.name} (${skill.code})`;
                    option.dataset.skillId = skill.id;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });
        }

        function populateClassDropdowns() {
            populateSkillDropdowns();
        }

        // Handle Enrollment Upload
        function handleEnrollmentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    let imported = 0;
                    let skipped = 0;
                    jsonData.forEach(row => {
                        // Try different possible column names
                        const name = row['Student Name'] || row['Name'] || row['STUDENT NAME'] || row['name'];
                        const regNo = row['Registration Number'] || row['Reg No'] || row['RegNo'] || row['REGISTRATION NUMBER'] || row['ID'];
                        const skillType = row['Skill Type'] || row['Class'] || row['SKILL TYPE'] || row['class'] || row['Course'];
                        const contact = row['Contact'] || row['Phone'] || row['CONTACT'] || row['phone'] || '';

                        if (name && regNo && skillType) {
                            // Check if skill exists
                            const skillExists = skills.find(s => s.name.toLowerCase() === skillType.toLowerCase());
                            if (!skillExists) {
                                console.warn(`Skill "${skillType}" not found in system. Skipping student: ${name}`);
                                skipped++;
                                return;
                            }

                            // Check if student already exists
                            const exists = students.find(s => s.regNo === String(regNo));
                            if (!exists) {
                                students.push({
                                    id: 'STU' + Date.now() + Math.random().toString(36).substr(2, 9),
                                    name: name,
                                    regNo: String(regNo),
                                    class: skillExists.name, // Use the skill name from system
                                    contact: contact,
                                    enrollmentDate: new Date().toISOString()
                                });
                                imported++;
                            }
                        }
                    });

                    saveStudents();
                    renderStudentsTable();
                    
                    let message = ` Successfully imported ${imported} students!`;
                    if (skipped > 0) {
                        message += `\n\n Skipped ${skipped} students due to invalid or missing skill types. Please ensure skill types in the Excel file match those defined in Skills Management.`;
                    }
                    alert(message);
                    event.target.value = ''; // Reset file input
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(' Error reading file. Please ensure it\'s a valid Excel file with the correct format.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Add Student Manually
        function addStudentManually() {
            const name = document.getElementById('newStudentName').value.trim();
            const regNo = document.getElementById('newStudentRegNo').value.trim();
            const skillClass = document.getElementById('newStudentClass').value;
            const contact = document.getElementById('newStudentContact').value.trim();

            if (!name || !regNo || !skillClass) {
                alert(' Please fill in all required fields (Name, Reg No, Skill)');
                return;
            }

            // Check if registration number already exists
            if (students.find(s => s.regNo === regNo)) {
                alert(' Registration number already exists');
                return;
            }

            students.push({
                id: 'STU' + Date.now() + Math.random().toString(36).substr(2, 9),
                name: name,
                regNo: regNo,
                class: skillClass,
                contact: contact,
                enrollmentDate: new Date().toISOString()
            });

            saveStudents();
            renderStudentsTable();

            // Clear form
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentRegNo').value = '';
            document.getElementById('newStudentClass').value = '';
            document.getElementById('newStudentContact').value = '';

            alert(' Student added successfully!');
        }

        // Render Students Table
        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No students enrolled yet</td></tr>';
                return;
            }

            students.forEach((student, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${student.regNo}</td>
                    <td>${student.name}</td>
                    <td><span class="badge badge-primary">${student.class}</span></td>
                    <td>${student.contact || 'N/A'}</td>
                    <td>${new Date(student.enrollmentDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editStudent(${index})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;"> Edit</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${index})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"> Delete</button>
                    </td>
                `;
            });
        }

        // Delete Student
        function deleteStudent(index) {
            if (confirm(`Are you sure you want to delete ${students[index].name}?`)) {
                students.splice(index, 1);
                saveStudents();
                renderStudentsTable();
                alert(' Student deleted');
            }
        }

        // Edit Student Functions
        function editStudent(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            editingStudentIndex = index;
            const student = students[index];

            // Populate edit form
            document.getElementById('editStudentNameInput').value = student.name;
            document.getElementById('editStudentRegNo').value = student.regNo;
            document.getElementById('editStudentContact').value = student.contact || '';
            
            // Populate enrollment date
            const enrollDate = new Date(student.enrollmentDate);
            const enrollDateStr = enrollDate.toISOString().split('T')[0];
            document.getElementById('editStudentEnrollmentDate').value = enrollDateStr;

            // Populate skill dropdown in modal
            const editSkillSelect = document.getElementById('editStudentClass');
            editSkillSelect.innerHTML = '<option value="">-- Select Skill --</option>';
            skills.forEach(skill => {
                const option = document.createElement('option');
                option.value = skill.name;
                option.textContent = `${skill.name} (${skill.code})`;
                if (skill.name === student.class) {
                    option.selected = true;
                }
                editSkillSelect.appendChild(option);
            });

            document.getElementById('editStudentModal').classList.add('active');
        }

        function closeEditStudentModal() {
            document.getElementById('editStudentModal').classList.remove('active');
            editingStudentIndex = null;
        }

        function saveStudentEdit() {
            if (editingStudentIndex === null) return;

            const student = students[editingStudentIndex];
            const oldName = student.name;
            const oldRegNo = student.regNo;
            const oldClass = student.class;

            const newName = document.getElementById('editStudentNameInput').value.trim();
            const newRegNo = document.getElementById('editStudentRegNo').value.trim();
            const newClass = document.getElementById('editStudentClass').value;
            const newContact = document.getElementById('editStudentContact').value.trim();
            const newEnrollDate = document.getElementById('editStudentEnrollmentDate').value;

            if (!newName || !newRegNo || !newClass) {
                alert(' Please fill in all required fields (Name, Reg No, Skill)');
                return;
            }

            // Check if registration number conflicts with another student
            const conflict = students.find((s, i) => 
                i !== editingStudentIndex && s.regNo === newRegNo
            );
            if (conflict) {
                alert(' Registration number already exists for another student');
                return;
            }

            // Update student
            student.name = newName;
            student.regNo = newRegNo;
            student.class = newClass;
            student.contact = newContact;
            if (newEnrollDate) {
                student.enrollmentDate = new Date(newEnrollDate).toISOString();
            }

            // Update all attendance records if name, regNo, or class changed
            if (oldName !== newName || oldRegNo !== newRegNo || oldClass !== newClass) {
                attendanceRecords.forEach(record => {
                    if (record.studentId === student.id) {
                        record.studentName = newName;
                        record.regNo = newRegNo;
                        record.class = newClass;
                    }
                });
                saveAttendanceRecords();
            }

            saveStudents();
            closeEditStudentModal();
            renderStudentsTable();

            alert(' Student updated successfully!');
        }

        // Skills Management Functions
        function addSkill() {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            const name = document.getElementById('newSkillName').value.trim();
            const code = document.getElementById('newSkillCode').value.trim();
            const duration = parseInt(document.getElementById('newSkillDuration').value);
            const instructor = document.getElementById('newSkillInstructor').value.trim();
            const description = document.getElementById('newSkillDescription').value.trim();
            const startTime = document.getElementById('newSkillStartTime').value;
            const endTime = document.getElementById('newSkillEndTime').value;
            const breakTime = parseInt(document.getElementById('newSkillBreakTime').value) || 0;
            const maxStudents = parseInt(document.getElementById('newSkillMaxStudents').value);

            if (!name) {
                alert(' Skill name is required');
                return;
            }

            // Check if skill name already exists
            if (skills.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                alert(' A skill with this name already exists');
                return;
            }

            skills.push({
                id: 'SKILL' + Date.now(),
                name: name,
                code: code,
                duration: duration,
                instructor: instructor,
                description: description,
                startTime: startTime,
                endTime: endTime,
                breakTime: breakTime,
                maxStudents: maxStudents,
                createdDate: new Date().toISOString()
            });

            saveSkills();
            renderSkillsTable();
            populateSkillDropdowns();

            // Clear form
            document.getElementById('newSkillName').value = '';
            document.getElementById('newSkillCode').value = '';
            document.getElementById('newSkillDuration').value = '';
            document.getElementById('newSkillInstructor').value = '';
            document.getElementById('newSkillDescription').value = '';
            document.getElementById('newSkillStartTime').value = '08:00';
            document.getElementById('newSkillEndTime').value = '16:00';
            document.getElementById('newSkillBreakTime').value = '30';
            document.getElementById('newSkillMaxStudents').value = '';

            alert(' Skill type added successfully!');
        }

        function renderSkillsTable() {
            const tbody = document.getElementById('skillsTable');
            tbody.innerHTML = '';

            if (skills.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No skills defined yet</td></tr>';
                return;
            }

            skills.forEach((skill, index) => {
                const enrolledCount = students.filter(s => s.class === skill.name).length;
                const schedule = `${skill.startTime || 'N/A'} - ${skill.endTime || 'N/A'}`;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${skill.code || 'N/A'}</td>
                    <td><strong>${skill.name}</strong></td>
                    <td>${skill.duration ? skill.duration + ' weeks' : 'N/A'}</td>
                    <td>${skill.instructor || 'N/A'}</td>
                    <td>${schedule}<br><small style="color: var(--text-secondary);">Break: ${skill.breakTime || 0} min</small></td>
                    <td>${skill.maxStudents || 'Unlimited'}</td>
                    <td><span class="badge badge-primary">${enrolledCount}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="editSkill(${index})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;"> Edit</button>
                        <button class="btn btn-danger" onclick="deleteSkill(${index})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"> Delete</button>
                    </td>
                `;
            });
        }

        function editSkill(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            editingSkillIndex = index;
            const skill = skills[index];

            document.getElementById('viewSkillName').value = skill.name;
            document.getElementById('viewSkillCode').value = skill.code || '';
            document.getElementById('viewSkillDuration').value = skill.duration || '';
            document.getElementById('viewSkillInstructor').value = skill.instructor || '';
            document.getElementById('viewSkillDescription').value = skill.description || '';
            document.getElementById('viewSkillStartTime').value = skill.startTime || '08:00';
            document.getElementById('viewSkillEndTime').value = skill.endTime || '16:00';
            document.getElementById('viewSkillBreakTime').value = skill.breakTime || 0;
            document.getElementById('viewSkillMaxStudents').value = skill.maxStudents || '';

            document.getElementById('viewSkillModal').classList.add('active');
        }

        function closeViewSkillModal() {
            document.getElementById('viewSkillModal').classList.remove('active');
            editingSkillIndex = null;
        }

        function saveSkillEdit() {
            if (editingSkillIndex === null) return;

            const skill = skills[editingSkillIndex];
            const oldName = skill.name;
            const newName = document.getElementById('viewSkillName').value.trim();

            if (!newName) {
                alert(' Skill name is required');
                return;
            }

            // Check if new name conflicts with another skill
            const conflict = skills.find((s, i) => 
                i !== editingSkillIndex && s.name.toLowerCase() === newName.toLowerCase()
            );
            if (conflict) {
                alert(' A skill with this name already exists');
                return;
            }

            // Update skill
            skill.name = newName;
            skill.code = document.getElementById('viewSkillCode').value.trim();
            skill.duration = parseInt(document.getElementById('viewSkillDuration').value) || null;
            skill.instructor = document.getElementById('viewSkillInstructor').value.trim();
            skill.description = document.getElementById('viewSkillDescription').value.trim();
            skill.startTime = document.getElementById('viewSkillStartTime').value;
            skill.endTime = document.getElementById('viewSkillEndTime').value;
            skill.breakTime = parseInt(document.getElementById('viewSkillBreakTime').value) || 0;
            skill.maxStudents = parseInt(document.getElementById('viewSkillMaxStudents').value) || null;

            // Update all students with old skill name to new name
            if (oldName !== newName) {
                students.forEach(student => {
                    if (student.class === oldName) {
                        student.class = newName;
                    }
                });
                saveStudents();

                // Update attendance records
                attendanceRecords.forEach(record => {
                    if (record.class === oldName) {
                        record.class = newName;
                    }
                });
                saveAttendanceRecords();
            }

            saveSkills();
            closeViewSkillModal();
            renderSkillsTable();
            populateSkillDropdowns();
            renderStudentsTable();

            alert(' Skill updated successfully!');
        }

        function deleteSkill(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            const skill = skills[index];
            const enrolledCount = students.filter(s => s.class === skill.name).length;

            if (enrolledCount > 0) {
                if (!confirm(` Warning: ${enrolledCount} student(s) are enrolled in "${skill.name}". Deleting this skill will not delete the students, but they will have an invalid skill type. Are you sure you want to continue?`)) {
                    return;
                }
            }

            if (confirm(`Are you sure you want to delete the skill "${skill.name}"?`)) {
                skills.splice(index, 1);
                saveSkills();
                renderSkillsTable();
                populateSkillDropdowns();
                alert(' Skill deleted');
            }
        }

        // Filter Students Table
        function filterStudentsTable() {
            const searchTerm = document.getElementById('studentSearchBox').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Load Students for Attendance Marking
        function loadStudentsForAttendance() {
            const selectedClass = document.getElementById('attendanceClassSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!selectedClass || !date) {
                document.getElementById('attendanceStudentsList').style.display = 'none';
                return;
            }

            const classStudents = students.filter(s => s.class === selectedClass);

            if (classStudents.length === 0) {
                alert('No students found in this class');
                return;
            }

            // Get skill data for default times
            const skill = skills.find(s => s.name === selectedClass);
            const defaultStartTime = skill ? skill.startTime : '08:00';
            const defaultEndTime = skill ? skill.endTime : '16:00';
            const defaultBreakTime = skill ? skill.breakTime : 30;

            const container = document.getElementById('studentsForAttendance');
            container.innerHTML = '';

            classStudents.forEach(student => {
                // Check if attendance already exists for this student on this date
                const existingAttendance = attendanceRecords.find(
                    a => a.studentId === student.id && a.date === date
                );

                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-card-header">
                        <div class="student-name">${student.name}</div>
                        <div><span class="badge badge-info">${student.regNo}</span></div>
                    </div>
                    <div class="student-info">
                        <div><strong>Class:</strong> ${student.class}</div>
                    </div>
                    <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                        <div class="form-group">
                            <label style="font-size: 0.85rem;">Status</label>
                            <select class="attendance-status" data-student-id="${student.id}" style="padding: 0.4rem;">
                                <option value="Present" ${existingAttendance && existingAttendance.status === 'Present' ? 'selected' : ''}>Present</option>
                                <option value="Absent" ${existingAttendance && existingAttendance.status === 'Absent' ? 'selected' : ''}>Absent</option>
                                <option value="Late" ${existingAttendance && existingAttendance.status === 'Late' ? 'selected' : ''}>Late</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem;">Time In</label>
                            <input type="time" class="attendance-time-in" data-student-id="${student.id}" value="${existingAttendance ? existingAttendance.timeIn : defaultStartTime}" style="padding: 0.4rem;">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem;">Time Out</label>
                            <input type="time" class="attendance-time-out" data-student-id="${student.id}" value="${existingAttendance ? existingAttendance.timeOut : defaultEndTime}" style="padding: 0.4rem;">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem;">Break (min)</label>
                            <input type="number" class="attendance-break" data-student-id="${student.id}" value="${existingAttendance ? existingAttendance.breakTime : defaultBreakTime}" min="0" placeholder="0" style="padding: 0.4rem;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label style="font-size: 0.85rem;">Notes (optional)</label>
                        <textarea class="attendance-notes" data-student-id="${student.id}" rows="2" placeholder="Add any notes..." style="padding: 0.4rem;">${existingAttendance ? existingAttendance.notes || '' : ''}</textarea>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('attendanceStudentsList').style.display = 'block';
        }

        // Save All Attendance
        function saveAllAttendance() {
            const selectedClass = document.getElementById('attendanceClassSelect').value;
            const date = document.getElementById('attendanceDate').value;

            if (!selectedClass || !date) {
                alert('Please select class and date');
                return;
            }

            const statusInputs = document.querySelectorAll('.attendance-status');
            let savedCount = 0;

            statusInputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const student = students.find(s => s.id === studentId);
                
                const status = input.value;
                const timeIn = document.querySelector(`.attendance-time-in[data-student-id="${studentId}"]`).value;
                const timeOut = document.querySelector(`.attendance-time-out[data-student-id="${studentId}"]`).value;
                const breakTime = parseInt(document.querySelector(`.attendance-break[data-student-id="${studentId}"]`).value) || 0;
                const notes = document.querySelector(`.attendance-notes[data-student-id="${studentId}"]`).value;

                // Remove existing attendance for this student on this date
                attendanceRecords = attendanceRecords.filter(
                    a => !(a.studentId === studentId && a.date === date)
                );

                // Add new attendance record
                attendanceRecords.push({
                    id: 'ATT' + Date.now() + Math.random().toString(36).substr(2, 9),
                    studentId: studentId,
                    studentName: student.name,
                    regNo: student.regNo,
                    class: student.class,
                    date: date,
                    status: status,
                    timeIn: timeIn,
                    timeOut: timeOut,
                    breakTime: breakTime,
                    notes: notes,
                    recordedBy: currentUser.fullName,
                    recordedAt: new Date().toISOString()
                });

                savedCount++;
            });

            saveAttendanceRecords();
            renderTodayAttendance();
            
            alert(` Attendance saved for ${savedCount} students!`);
            
            // Clear the form
            document.getElementById('attendanceClassSelect').value = '';
            document.getElementById('attendanceStudentsList').style.display = 'none';
        }

        // Render Today's Attendance
        function renderTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const filterClass = document.getElementById('todayFilterClass').value;

            let todayRecords = attendanceRecords.filter(a => a.date === today);
            
            if (filterClass) {
                todayRecords = todayRecords.filter(a => a.class === filterClass);
            }

            // Update stats
            const presentCount = todayRecords.filter(a => a.status === 'Present').length;
            const absentCount = todayRecords.filter(a => a.status === 'Absent').length;
            const lateCount = todayRecords.filter(a => a.status === 'Late').length;

            document.getElementById('todayPresentCount').textContent = presentCount;
            document.getElementById('todayAbsentCount').textContent = absentCount;
            document.getElementById('todayLateCount').textContent = lateCount;
            document.getElementById('todayTotalCount').textContent = todayRecords.length;

            // Render table
            const tbody = document.getElementById('todayAttendanceTable');
            tbody.innerHTML = '';

            if (todayRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No attendance records for today</td></tr>';
                return;
            }

            todayRecords.forEach(record => {
                const netHours = calculateNetHours(record.timeIn, record.timeOut, record.breakTime);
                const statusBadge = getStatusBadge(record.status);

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.studentName}</td>
                    <td><span class="badge badge-primary">${record.class}</span></td>
                    <td>${record.timeIn || 'N/A'}</td>
                    <td>${record.timeOut || 'N/A'}</td>
                    <td>${record.breakTime} min</td>
                    <td>${statusBadge}</td>
                    <td><strong>${netHours}</strong></td>
                `;
            });
        }

        // History Month/Year Navigation
        function initializeHistoryView() {
            const now = new Date();
            const yearSelect = document.getElementById('historyYear');
            const monthSelect = document.getElementById('historyMonth');

            // Populate years (5 years back to current year)
            yearSelect.innerHTML = '';
            const currentYear = now.getFullYear();
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Set current month and year
            monthSelect.value = now.getMonth();
            yearSelect.value = currentYear;

            updateHistoryView();
        }

        function navigateHistoryMonth(direction) {
            const monthSelect = document.getElementById('historyMonth');
            const yearSelect = document.getElementById('historyYear');

            let month = parseInt(monthSelect.value);
            let year = parseInt(yearSelect.value);

            month += direction;

            if (month > 11) {
                month = 0;
                year++;
            } else if (month < 0) {
                month = 11;
                year--;
            }

            // Update year select if needed (add new year option if not exists)
            if (!Array.from(yearSelect.options).find(opt => opt.value == year)) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (direction > 0) {
                    yearSelect.appendChild(option);
                } else {
                    yearSelect.insertBefore(option, yearSelect.firstChild);
                }
            }

            monthSelect.value = month;
            yearSelect.value = year;

            updateHistoryView();
        }

        function goToCurrentMonth() {
            const now = new Date();
            const monthSelect = document.getElementById('historyMonth');
            const yearSelect = document.getElementById('historyYear');

            monthSelect.value = now.getMonth();
            yearSelect.value = now.getFullYear();

            updateHistoryView();
        }

        function updateHistoryView() {
            const month = parseInt(document.getElementById('historyMonth').value);
            const year = parseInt(document.getElementById('historyYear').value);
            const studentSearch = document.getElementById('historyStudentSearch').value.toLowerCase();
            const classFilter = document.getElementById('historyClassFilter').value;

            // Filter records by selected month/year
            let filtered = attendanceRecords.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === month && recordDate.getFullYear() === year;
            });

            // Apply additional filters
            if (studentSearch) {
                filtered = filtered.filter(a => a.studentName.toLowerCase().includes(studentSearch));
            }

            if (classFilter) {
                filtered = filtered.filter(a => a.class === classFilter);
            }

            // Sort by date descending
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate stats
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const totalRecords = filtered.length;
            const uniqueStudents = [...new Set(filtered.map(r => r.studentName))].length;
            let totalHours = 0;
            filtered.forEach(record => {
                const hours = parseFloat(calculateNetHours(record.timeIn, record.timeOut, record.breakTime));
                if (!isNaN(hours)) totalHours += hours;
            });

            // Update stats display
            const statsDiv = document.getElementById('historyStats');
            statsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: var(--space-3); text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${monthNames[month]} ${year}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Selected Period</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${totalRecords}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Records</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${uniqueStudents}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Unique Students</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalHours.toFixed(1)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Hours</div>
                    </div>
                </div>
            `;

            // Render table
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">No attendance records found for ${monthNames[month]} ${year}</td></tr>`;
                return;
            }

            filtered.forEach((record, index) => {
                const actualIndex = attendanceRecords.findIndex(a => a.id === record.id);
                const netHours = calculateNetHours(record.timeIn, record.timeOut, record.breakTime);
                const statusBadge = getStatusBadge(record.status);

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${record.studentName}</td>
                    <td><span class="badge badge-primary">${record.class}</span></td>
                    <td>${record.timeIn || 'N/A'}</td>
                    <td>${record.timeOut || 'N/A'}</td>
                    <td>${record.breakTime}</td>
                    <td>${statusBadge}</td>
                    <td><strong>${netHours}</strong></td>
                    <td ${currentUser.role !== 'Admin' ? 'style="display: none;"' : ''}>
                        <button class="btn btn-primary" onclick="openEditAttendanceModal(${actualIndex})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;"> Edit</button>
                        <button class="btn btn-danger" onclick="deleteAttendanceRecord(${actualIndex})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"> Delete</button>
                    </td>
                `;
            });
        }

        // Legacy filter function (redirects to new view)
        function filterHistory() {
            updateHistoryView();
        }

        // Edit Attendance Modal Functions
        function openEditAttendanceModal(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            editingAttendanceIndex = index;
            const record = attendanceRecords[index];

            document.getElementById('editStudentName').value = record.studentName;
            document.getElementById('editClass').value = record.class;
            document.getElementById('editDate').value = record.date;
            document.getElementById('editStatus').value = record.status;
            document.getElementById('editTimeIn').value = record.timeIn;
            document.getElementById('editTimeOut').value = record.timeOut;
            document.getElementById('editBreakTime').value = record.breakTime;
            document.getElementById('editNotes').value = record.notes || '';

            document.getElementById('editAttendanceModal').classList.add('active');
        }

        function closeEditAttendanceModal() {
            document.getElementById('editAttendanceModal').classList.remove('active');
            editingAttendanceIndex = null;
        }

        function saveAttendanceEdit() {
            if (editingAttendanceIndex === null) return;

            const record = attendanceRecords[editingAttendanceIndex];
            
            record.date = document.getElementById('editDate').value;
            record.status = document.getElementById('editStatus').value;
            record.timeIn = document.getElementById('editTimeIn').value;
            record.timeOut = document.getElementById('editTimeOut').value;
            record.breakTime = parseInt(document.getElementById('editBreakTime').value) || 0;
            record.notes = document.getElementById('editNotes').value;

            saveAttendanceRecords();
            closeEditAttendanceModal();
            filterHistory();
            renderTodayAttendance();

            alert(' Attendance record updated successfully!');
        }

        function deleteAttendanceRecord(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            const record = attendanceRecords[index];
            
            if (confirm(`Are you sure you want to delete the attendance record for ${record.studentName} on ${new Date(record.date).toLocaleDateString()}?`)) {
                attendanceRecords.splice(index, 1);
                saveAttendanceRecords();
                filterHistory();
                renderTodayAttendance();
                alert(' Attendance record deleted');
            }
        }

        // Generate Report
        // Store current report data for exports
        let currentReportData = [];
        let currentReportFilters = {};

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const classFilter = document.getElementById('reportClassSelect').value;
            const studentFilter = document.getElementById('reportStudentFilter').value.trim().toLowerCase();
            const statusFilter = document.getElementById('reportStatusFilter').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            let filtered = [...attendanceRecords];

            // Store filters for export headers
            currentReportFilters = {
                reportType,
                classFilter,
                studentFilter,
                statusFilter,
                fromDate,
                toDate
            };

            // Apply Class/Skill filter
            if (classFilter) {
                filtered = filtered.filter(a => a.class === classFilter);
            }

            // Apply Student Name filter (partial match, case-insensitive)
            if (studentFilter) {
                filtered = filtered.filter(a =>
                    a.studentName.toLowerCase().includes(studentFilter) ||
                    (a.regNo && a.regNo.toLowerCase().includes(studentFilter))
                );
            }

            // Apply Status filter
            if (statusFilter) {
                filtered = filtered.filter(a => a.status === statusFilter);
            }

            // Apply Date Range filters
            if (fromDate) {
                filtered = filtered.filter(a => a.date >= fromDate);
            }

            if (toDate) {
                filtered = filtered.filter(a => a.date <= toDate);
            }

            if (filtered.length === 0) {
                alert('No records found for the selected criteria. Try adjusting your filters.');
                document.getElementById('reportResults').style.display = 'none';
                return;
            }

            // Store filtered data for exports
            currentReportData = filtered;

            // Calculate stats
            const totalPresent = filtered.filter(a => a.status === 'Present').length;
            const totalAbsent = filtered.filter(a => a.status === 'Absent').length;
            const totalLate = filtered.filter(a => a.status === 'Late').length;
            const attendanceRate = ((totalPresent + totalLate) / filtered.length * 100).toFixed(1);

            // Calculate total hours worked
            let totalMinutes = 0;
            filtered.forEach(record => {
                if (record.timeIn && record.timeOut) {
                    const [inH, inM] = record.timeIn.split(':').map(Number);
                    const [outH, outM] = record.timeOut.split(':').map(Number);
                    const mins = (outH * 60 + outM) - (inH * 60 + inM) - (record.breakTime || 0);
                    if (mins > 0) totalMinutes += mins;
                }
            });
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = totalMinutes % 60;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value">${filtered.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Present</div>
                    <div class="stat-value" style="color: var(--success);">${totalPresent}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Absent</div>
                    <div class="stat-value" style="color: var(--danger);">${totalAbsent}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Late</div>
                    <div class="stat-value" style="color: var(--warning);">${totalLate}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Attendance Rate</div>
                    <div class="stat-value">${attendanceRate}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-value">${totalHours}h ${totalMins}m</div>
                </div>
            `;

            document.getElementById('reportStats').innerHTML = statsHtml;

            // Update record count
            document.getElementById('reportRecordCount').textContent = `(${filtered.length} records)`;

            // Update print header info
            const dateRangeText = fromDate || toDate
                ? `Date Range: ${fromDate || 'Start'} to ${toDate || 'Present'}`
                : `All Dates`;
            document.getElementById('printReportDate').textContent = dateRangeText;

            const filterParts = [];
            if (classFilter) filterParts.push(`${classFilter} Class`);
            if (studentFilter) filterParts.push(`Student: ${studentFilter}`);
            if (statusFilter) filterParts.push(`Status: ${statusFilter}`);
            document.getElementById('printReportFilters').textContent = filterParts.length > 0
                ? `Filters: ${filterParts.join(' | ')}`
                : 'All Records';
            document.getElementById('printGeneratedDate').textContent = new Date().toLocaleString();

            // Render table
            const thead = document.getElementById('reportTableHead');
            const tbody = document.getElementById('reportTableBody');

            thead.innerHTML = `
                <tr>
                    <th>Date</th>
                    <th>Student Name</th>
                    <th>Reg No</th>
                    <th>Class/Skill</th>
                    <th>Status</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Break (min)</th>
                    <th>Net Hours</th>
                </tr>
            `;

            tbody.innerHTML = '';

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const netHours = calculateNetHours(record.timeIn, record.timeOut, record.breakTime);
                const statusBadge = getStatusBadge(record.status);

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${record.studentName}</td>
                    <td>${record.regNo}</td>
                    <td>${record.class}</td>
                    <td>${statusBadge}</td>
                    <td>${record.timeIn || 'N/A'}</td>
                    <td>${record.timeOut || 'N/A'}</td>
                    <td>${record.breakTime || 0}</td>
                    <td><strong>${netHours}</strong></td>
                `;
            });

            document.getElementById('reportResults').style.display = 'block';
        }

        // Clear all report filters
        function clearReportFilters() {
            document.getElementById('reportType').value = 'all';
            document.getElementById('reportClassSelect').value = '';
            document.getElementById('reportStudentFilter').value = '';
            document.getElementById('reportStatusFilter').value = '';
            document.getElementById('reportFromDate').value = '';
            document.getElementById('reportToDate').value = '';
            document.getElementById('reportResults').style.display = 'none';
            currentReportData = [];
            currentReportFilters = {};
        }

        // Export Report to Excel
        function exportReportToExcel() {
            if (currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            // Create workbook with formatted data
            const exportData = currentReportData.map(record => ({
                'Date': new Date(record.date).toLocaleDateString(),
                'Student Name': record.studentName,
                'Reg No': record.regNo,
                'Class/Skill': record.class,
                'Status': record.status,
                'Time In': record.timeIn || 'N/A',
                'Time Out': record.timeOut || 'N/A',
                'Break (min)': record.breakTime || 0,
                'Net Hours': calculateNetHours(record.timeIn, record.timeOut, record.breakTime)
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');

            // Auto-size columns
            const colWidths = [
                { wch: 12 }, // Date
                { wch: 25 }, // Student Name
                { wch: 12 }, // Reg No
                { wch: 20 }, // Class
                { wch: 10 }, // Status
                { wch: 10 }, // Time In
                { wch: 10 }, // Time Out
                { wch: 12 }, // Break
                { wch: 12 }  // Net Hours
            ];
            ws['!cols'] = colWidths;

            XLSX.writeFile(wb, `Attendance_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Export Report to PDF
        function exportReportToPDF() {
            if (currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

            // Add header
            doc.setFontSize(18);
            doc.setTextColor(30, 58, 95); // Primary color
            doc.text('CESTIS Attendance Report', 148, 15, { align: 'center' });

            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Community Educational and Skills Training Institute and Services Limited', 148, 22, { align: 'center' });

            // Add filter info
            doc.setFontSize(9);
            const filterParts = [];
            if (currentReportFilters.classFilter) filterParts.push(`${currentReportFilters.classFilter} Class`);
            if (currentReportFilters.studentFilter) filterParts.push(`Student: ${currentReportFilters.studentFilter}`);
            if (currentReportFilters.statusFilter) filterParts.push(`Status: ${currentReportFilters.statusFilter}`);
            if (currentReportFilters.fromDate || currentReportFilters.toDate) {
                filterParts.push(`Date: ${currentReportFilters.fromDate || 'Start'} to ${currentReportFilters.toDate || 'Present'}`);
            }
            const filterText = filterParts.length > 0 ? filterParts.join(' | ') : 'All Records';
            doc.text(`Filters: ${filterText}`, 14, 30);

            // Calculate stats for summary
            const totalPresent = currentReportData.filter(a => a.status === 'Present').length;
            const totalAbsent = currentReportData.filter(a => a.status === 'Absent').length;
            const totalLate = currentReportData.filter(a => a.status === 'Late').length;
            const attendanceRate = ((totalPresent + totalLate) / currentReportData.length * 100).toFixed(1);

            // Add summary stats
            doc.setFontSize(9);
            doc.text(`Summary: ${currentReportData.length} Records | Present: ${totalPresent} | Absent: ${totalAbsent} | Late: ${totalLate} | Attendance Rate: ${attendanceRate}%`, 14, 36);

            // Prepare table data
            const tableData = currentReportData.map(record => [
                new Date(record.date).toLocaleDateString(),
                record.studentName,
                record.regNo,
                record.class,
                record.status,
                record.timeIn || 'N/A',
                record.timeOut || 'N/A',
                (record.breakTime || 0).toString(),
                calculateNetHours(record.timeIn, record.timeOut, record.breakTime)
            ]);

            // Generate table using autoTable
            doc.autoTable({
                startY: 42,
                head: [['Date', 'Student Name', 'Reg No', 'Class/Skill', 'Status', 'Time In', 'Time Out', 'Break', 'Net Hours']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [30, 58, 95],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                bodyStyles: {
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                columnStyles: {
                    0: { cellWidth: 22 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 22 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 18 },
                    5: { cellWidth: 18 },
                    6: { cellWidth: 18 },
                    7: { cellWidth: 15 },
                    8: { cellWidth: 20 }
                },
                didParseCell: function(data) {
                    // Color code status column
                    if (data.column.index === 4 && data.section === 'body') {
                        if (data.cell.raw === 'Present') {
                            data.cell.styles.textColor = [5, 150, 105];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (data.cell.raw === 'Absent') {
                            data.cell.styles.textColor = [220, 38, 38];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (data.cell.raw === 'Late') {
                            data.cell.styles.textColor = [217, 119, 6];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                },
                margin: { left: 14, right: 14 }
            });

            // Add footer with page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(
                    `Generated: ${new Date().toLocaleString()} | Page ${i} of ${pageCount} | CESTIS Student Attendance System`,
                    148,
                    doc.internal.pageSize.height - 10,
                    { align: 'center' }
                );
            }

            doc.save(`Attendance_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Professional Print Window Function (adapted from Hospital Management System)
        function openPrintWindow(title, content) {
            const printWindow = window.open('', '_blank');

            if (!printWindow) {
                alert(' Unable to open print window. Please allow popups for this site and try again.');
                return;
            }

            try {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${title} - CESTIS Attendance System</title>
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }

                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                                margin: 20px;
                                color: #1a202c;
                                font-size: 12px;
                            }

                            .header {
                                text-align: center;
                                border-bottom: 4px solid #1e3a5f;
                                padding-bottom: 20px;
                                margin-bottom: 25px;
                            }

                            .logo {
                                font-size: 2.5em;
                                margin-bottom: 10px;
                            }

                            h1 {
                                font-size: 24px;
                                color: #1e3a5f;
                                margin-bottom: 8px;
                            }

                            h2 {
                                font-size: 16px;
                                color: #64748b;
                                font-weight: normal;
                            }

                            .subtitle {
                                font-size: 13px;
                                color: #64748b;
                                margin-top: 5px;
                            }

                            h3 {
                                font-size: 16px;
                                color: #1e3a5f;
                                margin: 25px 0 12px 0;
                                padding-bottom: 8px;
                                border-bottom: 2px solid #e2e8f0;
                            }

                            .timestamp {
                                text-align: right;
                                font-size: 11px;
                                color: #64748b;
                                margin-top: 10px;
                            }

                            .filter-info {
                                background: #f8fafc;
                                border: 1px solid #e2e8f0;
                                border-radius: 6px;
                                padding: 12px 16px;
                                margin-bottom: 20px;
                                font-size: 12px;
                                color: #475569;
                            }

                            .filter-info strong {
                                color: #1e3a5f;
                            }

                            .summary-grid {
                                display: grid;
                                grid-template-columns: repeat(6, 1fr);
                                gap: 15px;
                                margin: 20px 0;
                            }

                            .summary-card {
                                text-align: center;
                                padding: 15px 10px;
                                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                                border-radius: 8px;
                                border: 1px solid #e2e8f0;
                            }

                            .summary-value {
                                font-size: 24px;
                                font-weight: bold;
                                color: #1e3a5f;
                            }

                            .summary-value.present { color: #059669; }
                            .summary-value.absent { color: #dc2626; }
                            .summary-value.late { color: #d97706; }
                            .summary-value.rate { color: #0ea5e9; }
                            .summary-value.hours { color: #7c3aed; }

                            .summary-label {
                                font-size: 11px;
                                color: #64748b;
                                margin-top: 5px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            }

                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 15px 0;
                                font-size: 11px;
                            }

                            th {
                                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
                                color: white;
                                padding: 10px 8px;
                                text-align: left;
                                font-weight: 600;
                                border: 1px solid #1e3a5f;
                                font-size: 11px;
                            }

                            td {
                                border: 1px solid #e2e8f0;
                                padding: 8px;
                                text-align: left;
                            }

                            tr:nth-child(even) {
                                background: #f8fafc;
                            }

                            tr:hover {
                                background: #f1f5f9;
                            }

                            .status-present {
                                color: #059669;
                                font-weight: 600;
                            }

                            .status-absent {
                                color: #dc2626;
                                font-weight: 600;
                            }

                            .status-late {
                                color: #d97706;
                                font-weight: 600;
                            }

                            .footer {
                                margin-top: 30px;
                                padding-top: 15px;
                                border-top: 2px solid #e2e8f0;
                                text-align: center;
                                font-size: 10px;
                                color: #64748b;
                            }

                            .footer p {
                                margin: 3px 0;
                            }

                            @media print {
                                body {
                                    margin: 10mm;
                                    -webkit-print-color-adjust: exact;
                                    print-color-adjust: exact;
                                }

                                .header {
                                    page-break-after: avoid;
                                }

                                table {
                                    page-break-inside: auto;
                                }

                                tr {
                                    page-break-inside: avoid;
                                    page-break-after: auto;
                                }

                                thead {
                                    display: table-header-group;
                                }

                                @page {
                                    size: A4 landscape;
                                    margin: 10mm;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo"></div>
                            <h1>${title}</h1>
                            <h2>CESTIS - Community Educational and Skills Training Institute and Services Limited</h2>
                            <p class="subtitle">Student Attendance System</p>
                            <div class="timestamp">Generated: ${new Date().toLocaleString()}</div>
                        </div>
                        ${content}
                        <div class="footer">
                            <p><strong>CESTIS Student Attendance System</strong></p>
                            <p>Report generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                            <p>This is an official attendance record document.</p>
                        </div>
                        <script>
                            window.onload = function() {
                                setTimeout(function() {
                                    window.print();
                                }, 250);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            } catch (error) {
                console.error('Print window error:', error);
                alert(' Error opening print window. Please check your browser settings.');
            }
        }

        // Print Attendance Report
        function printReport() {
            if (currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            // Calculate statistics
            const totalPresent = currentReportData.filter(a => a.status === 'Present').length;
            const totalAbsent = currentReportData.filter(a => a.status === 'Absent').length;
            const totalLate = currentReportData.filter(a => a.status === 'Late').length;
            const attendanceRate = ((totalPresent + totalLate) / currentReportData.length * 100).toFixed(1);

            // Calculate total hours
            let totalMinutes = 0;
            currentReportData.forEach(record => {
                if (record.timeIn && record.timeOut) {
                    const [inH, inM] = record.timeIn.split(':').map(Number);
                    const [outH, outM] = record.timeOut.split(':').map(Number);
                    const mins = (outH * 60 + outM) - (inH * 60 + inM) - (record.breakTime || 0);
                    if (mins > 0) totalMinutes += mins;
                }
            });
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = totalMinutes % 60;

            // Build filter description
            const filterParts = [];
            if (currentReportFilters.classFilter) filterParts.push(`${currentReportFilters.classFilter} Class`);
            if (currentReportFilters.studentFilter) filterParts.push(`Student: ${currentReportFilters.studentFilter}`);
            if (currentReportFilters.statusFilter) filterParts.push(`Status: ${currentReportFilters.statusFilter}`);
            if (currentReportFilters.fromDate) filterParts.push(`From: ${currentReportFilters.fromDate}`);
            if (currentReportFilters.toDate) filterParts.push(`To: ${currentReportFilters.toDate}`);
            const filterText = filterParts.length > 0 ? filterParts.join(' | ') : 'All Records (No filters applied)';

            // Build the report content
            const reportContent = `
                <div class="filter-info">
                    <strong>Report Filters:</strong> ${filterText}
                </div>

                <h3> Attendance Summary</h3>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value">${currentReportData.length}</div>
                        <div class="summary-label">Total Records</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value present">${totalPresent}</div>
                        <div class="summary-label">Present</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value absent">${totalAbsent}</div>
                        <div class="summary-label">Absent</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value late">${totalLate}</div>
                        <div class="summary-label">Late</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value rate">${attendanceRate}%</div>
                        <div class="summary-label">Attendance Rate</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value hours">${totalHours}h ${totalMins}m</div>
                        <div class="summary-label">Total Hours</div>
                    </div>
                </div>

                <h3> Attendance Records (${currentReportData.length} entries)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Student Name</th>
                            <th>Reg No</th>
                            <th>Class/Skill</th>
                            <th>Status</th>
                            <th>Time In</th>
                            <th>Time Out</th>
                            <th>Break (min)</th>
                            <th>Net Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentReportData.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => {
                            const netHours = calculateNetHours(record.timeIn, record.timeOut, record.breakTime);
                            const statusClass = record.status === 'Present' ? 'status-present' :
                                               record.status === 'Absent' ? 'status-absent' : 'status-late';
                            return `
                                <tr>
                                    <td>${new Date(record.date).toLocaleDateString()}</td>
                                    <td><strong>${record.studentName}</strong></td>
                                    <td>${record.regNo}</td>
                                    <td>${record.class}</td>
                                    <td class="${statusClass}">${record.status}</td>
                                    <td>${record.timeIn || 'N/A'}</td>
                                    <td>${record.timeOut || 'N/A'}</td>
                                    <td>${record.breakTime || 0}</td>
                                    <td><strong>${netHours}</strong></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            openPrintWindow('Attendance Report', reportContent);
        }

        // User Management
        function addUser() {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const forcePasswordChange = document.getElementById('newUserForcePasswordChange').checked;

            if (!name || !username || !password) {
                alert(' Please fill in all required fields');
                return;
            }

            if (users.find(u => u.username === username)) {
                alert(' Username already exists');
                return;
            }

            users.push({
                id: 'USER' + Date.now(),
                username: username,
                password: password,
                fullName: name,
                role: role,
                forcePasswordChange: forcePasswordChange,
                createdDate: new Date().toISOString()
            });

            saveUsers();
            renderUsersTable();

            document.getElementById('newUserName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserForcePasswordChange').checked = false;

            alert(' User added successfully!');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                const roleBadge = user.role === 'Admin' ? 'badge-danger' : 'badge-primary';
                const twoFAStatus = user.twoFactorEnabled ?
                    '<span class="twofa-status-badge enabled">Enabled</span>' :
                    '<span class="twofa-status-badge disabled">Disabled</span>';
                const pwdChangeStatus = user.forcePasswordChange ?
                    '<span class="badge badge-warning" style="font-size: 0.7rem;">Required</span>' : '';

                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullName}</td>
                    <td><span class="badge ${roleBadge}">${user.role}</span></td>
                    <td>${twoFAStatus}</td>
                    <td>${pwdChangeStatus}</td>
                    <td>${new Date(user.createdDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="openEditUserModal(${index})" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;"> Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser(${index})" ${user.role === 'Admin' && users.filter(u => u.role === 'Admin').length === 1 ? 'disabled' : ''} style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"> Delete</button>
                    </td>
                `;
            });

            // Also render current user's 2FA status
            render2FAStatus();
        }

        function deleteUser(index) {
            if (confirm(`Are you sure you want to delete user ${users[index].username}?`)) {
                users.splice(index, 1);
                saveUsers();
                renderUsersTable();
                alert('User deleted');
            }
        }

        function openEditUserModal(index) {
            if (currentUser.role !== 'Admin') {
                alert(' Admin access required');
                return;
            }

            editingUserIndex = index;
            const user = users[index];

            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserForcePasswordChange').checked = user.forcePasswordChange || false;

            document.getElementById('editUserModal').classList.add('active');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
            editingUserIndex = null;
        }

        function saveUserEdit() {
            if (editingUserIndex === null) return;

            const fullName = document.getElementById('editUserFullName').value.trim();
            const username = document.getElementById('editUserUsername').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            const forcePasswordChange = document.getElementById('editUserForcePasswordChange').checked;

            if (!fullName || !username) {
                alert(' Please fill in all required fields');
                return;
            }

            // Check if username already exists (excluding current user)
            const existingUser = users.find((u, idx) => u.username === username && idx !== editingUserIndex);
            if (existingUser) {
                alert(' Username already exists');
                return;
            }

            // Prevent removing the last admin
            const user = users[editingUserIndex];
            if (user.role === 'Admin' && role !== 'Admin' && users.filter(u => u.role === 'Admin').length === 1) {
                alert(' Cannot change role: This is the only admin account');
                return;
            }

            // Update user
            users[editingUserIndex].fullName = fullName;
            users[editingUserIndex].username = username;
            users[editingUserIndex].role = role;
            users[editingUserIndex].forcePasswordChange = forcePasswordChange;

            // Only update password if provided
            if (password) {
                users[editingUserIndex].password = password;
            }

            saveUsers();
            renderUsersTable();
            closeEditUserModal();

            // Update currentUser display if editing self
            if (currentUser.id === users[editingUserIndex].id) {
                currentUser = users[editingUserIndex];
                sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                document.getElementById('currentUserDisplay').textContent = ` ${currentUser.fullName} (${currentUser.role})`;
            }

            alert(' User updated successfully!');
        }

        // ============================================
        // Two-Factor Authentication (2FA) Functions
        // ============================================

        // Temporary storage for 2FA setup
        let pendingTwoFASecret = null;
        let pendingBackupCodes = null;

        // Generate a random base32 secret for TOTP
        function generateTOTPSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        // Generate TOTP code from secret (for verification)
        function generateTOTPCode(secret) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'CESTIS Attendance',
                    label: currentUser ? currentUser.username : 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                return totp.generate();
            } catch (e) {
                console.error('Error generating TOTP:', e);
                return null;
            }
        }

        // Verify TOTP code
        function verifyTOTPCode(secret, code) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'CESTIS Attendance',
                    label: 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                // Allow 1 period tolerance (30 seconds before/after)
                const delta = totp.validate({ token: code, window: 1 });
                return delta !== null;
            } catch (e) {
                console.error('Error verifying TOTP:', e);
                return false;
            }
        }

        // Generate TOTP URI for QR code
        function generateTOTPUri(secret, username) {
            const issuer = 'CESTIS%20Attendance';
            const label = encodeURIComponent(username);
            return `otpauth://totp/${issuer}:${label}?secret=${secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
        }

        // Generate backup codes
        function generateBackupCodes() {
            const codes = [];
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude similar characters
            for (let i = 0; i < 8; i++) {
                let code = '';
                for (let j = 0; j < 8; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                codes.push({ code: code, used: false });
            }
            return codes;
        }

        // Render current user's 2FA status
        function render2FAStatus() {
            const container = document.getElementById('current2FAStatus');
            if (!container || !currentUser) return;

            if (currentUser.twoFactorEnabled) {
                const unusedCodes = currentUser.backupCodes ?
                    currentUser.backupCodes.filter(bc => !bc.used).length : 0;

                container.innerHTML = `
                    <div class="twofa-success">
                        <strong>Two-Factor Authentication is ENABLED</strong>
                        <p style="margin-top: 0.5rem;">Your account is protected with Google Authenticator.</p>
                        <p style="margin-top: 0.25rem; font-size: 0.85rem;">Backup codes remaining: ${unusedCodes}/8</p>
                    </div>
                    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4); flex-wrap: wrap;">
                        <button class="btn btn-secondary twofa-setup-btn" onclick="showBackupCodes()">View Backup Codes</button>
                        <button class="btn btn-warning twofa-setup-btn" onclick="regenerateBackupCodes()">Regenerate Backup Codes</button>
                        <button class="btn btn-danger twofa-setup-btn" onclick="openTwoFADisable()">Disable 2FA</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                        <strong>Two-Factor Authentication is DISABLED</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">Add an extra layer of security to your account using Google Authenticator or any TOTP-compatible app.</p>
                    </div>
                    <button class="btn btn-success twofa-setup-btn" onclick="openTwoFASetup()">Enable 2FA</button>
                `;
            }
        }

        // Open 2FA setup modal
        function openTwoFASetup() {
            // Generate new secret
            pendingTwoFASecret = generateTOTPSecret();

            // Display secret key
            document.getElementById('twofaSecretKey').textContent = pendingTwoFASecret.match(/.{1,4}/g).join(' ');

            // Generate QR code
            const qrContainer = document.getElementById('twofaQRCode');
            qrContainer.innerHTML = '';
            const uri = generateTOTPUri(pendingTwoFASecret, currentUser.username);

            new QRCode(qrContainer, {
                text: uri,
                width: 200,
                height: 200,
                colorDark: '#1e3a5f',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });

            // Clear verification input
            document.getElementById('twofaSetupCode').value = '';

            // Show modal
            document.getElementById('twofaSetupModal').style.display = 'flex';
        }

        // Close 2FA setup modal
        function closeTwoFASetup() {
            document.getElementById('twofaSetupModal').style.display = 'none';
            pendingTwoFASecret = null;
        }

        // Confirm 2FA setup
        function confirmTwoFASetup() {
            const code = document.getElementById('twofaSetupCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!pendingTwoFASecret) {
                alert('Setup session expired. Please try again.');
                closeTwoFASetup();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(pendingTwoFASecret, code)) {
                // Generate backup codes
                pendingBackupCodes = generateBackupCodes();

                // Update user
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = true;
                    users[userIndex].twoFactorSecret = pendingTwoFASecret;
                    users[userIndex].backupCodes = pendingBackupCodes;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFASetup();

                // Show backup codes
                showBackupCodesModal();

                renderUsersTable();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaSetupCode').value = '';
                document.getElementById('twofaSetupCode').focus();
            }
        }

        // Show backup codes modal (after setup or on demand)
        function showBackupCodesModal() {
            const container = document.getElementById('twofaBackupCodes');
            const codes = pendingBackupCodes || currentUser.backupCodes || [];

            container.innerHTML = codes.map(bc => `
                <div class="twofa-backup-code ${bc.used ? 'used' : ''}">${bc.code}</div>
            `).join('');

            document.getElementById('twofaBackupModal').style.display = 'flex';
        }

        // Show existing backup codes
        function showBackupCodes() {
            pendingBackupCodes = null;
            showBackupCodesModal();
        }

        // Close backup codes modal
        function closeBackupCodesModal() {
            document.getElementById('twofaBackupModal').style.display = 'none';
            pendingBackupCodes = null;
        }

        // Copy backup codes to clipboard
        function copyBackupCodes() {
            const codes = pendingBackupCodes || currentUser.backupCodes || [];
            const codesText = codes.map((bc, i) => `${i + 1}. ${bc.code}${bc.used ? ' (USED)' : ''}`).join('\n');
            const fullText = `CESTIS Attendance - Backup Codes for ${currentUser.username}\n` +
                           `Generated: ${new Date().toLocaleString()}\n\n` +
                           `${codesText}\n\n` +
                           `Keep these codes in a safe place. Each code can only be used once.`;

            navigator.clipboard.writeText(fullText).then(() => {
                alert('Backup codes copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please manually select and copy the codes.');
            });
        }

        // Regenerate backup codes
        function regenerateBackupCodes() {
            if (!confirm('This will invalidate all existing backup codes. Continue?')) {
                return;
            }

            pendingBackupCodes = generateBackupCodes();

            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].backupCodes = pendingBackupCodes;
                saveUsers();
                currentUser = users[userIndex];
                sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
            }

            showBackupCodesModal();
            render2FAStatus();
        }

        // Open disable 2FA modal
        function openTwoFADisable() {
            document.getElementById('twofaDisableCode').value = '';
            document.getElementById('twofaDisableModal').style.display = 'flex';
        }

        // Close disable 2FA modal
        function closeTwoFADisable() {
            document.getElementById('twofaDisableModal').style.display = 'none';
        }

        // Confirm disable 2FA
        function confirmTwoFADisable() {
            const code = document.getElementById('twofaDisableCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!currentUser.twoFactorSecret) {
                alert('2FA is not enabled for this account.');
                closeTwoFADisable();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(currentUser.twoFactorSecret, code)) {
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = false;
                    users[userIndex].twoFactorSecret = null;
                    users[userIndex].backupCodes = null;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFADisable();
                alert('Two-Factor Authentication has been disabled.');
                renderUsersTable();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaDisableCode').value = '';
                document.getElementById('twofaDisableCode').focus();
            }
        }

        // Utility Functions
        function calculateNetHours(timeIn, timeOut, breakTime) {
            if (!timeIn || !timeOut) return 'N/A';

            const [inHours, inMinutes] = timeIn.split(':').map(Number);
            const [outHours, outMinutes] = timeOut.split(':').map(Number);

            const totalMinutes = (outHours * 60 + outMinutes) - (inHours * 60 + inMinutes) - breakTime;
            
            if (totalMinutes < 0) return 'Invalid';

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            return `${hours}h ${minutes}m`;
        }

        function getStatusBadge(status) {
            const badges = {
                'Present': '<span class="badge badge-success">Present</span>',
                'Absent': '<span class="badge badge-danger">Absent</span>',
                'Late': '<span class="badge badge-warning">Late</span>'
            };
            return badges[status] || status;
        }

        // Module Switching
        function switchModule(moduleId) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.module').forEach(module => module.classList.remove('active'));
            document.getElementById(moduleId).classList.add('active');

            // Initialize history view when switching to it
            if (moduleId === 'viewHistory') {
                initializeHistoryView();
            }
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('cestisAttendanceDarkMode', isDark);

            document.getElementById('themeIcon').textContent = isDark ? '' : '';
            document.getElementById('themeText').textContent = isDark ? 'Light' : 'Dark';
        }

        // ============================================
        // Google Drive Cloud Sync Integration
        // ============================================

        // Google Drive Configuration
        const GOOGLE_DRIVE_CONFIG = {
            // Google OAuth Client ID
            CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
            // Your Google Drive folder ID from the shared link
            FOLDER_ID: '11vWe_Nc40TtJ1Hi7PoE7EZ3JrpR-K0Vj',
            // File name for backup
            BACKUP_FILE_NAME: 'cestis_attendance_backup.json',
            // API scopes needed
            SCOPES: 'https://www.googleapis.com/auth/drive.file'
        };

        // Cloud sync state
        let googleAccessToken = null;
        let isCloudConnected = false;
        let lastSyncTime = null;
        let cloudFileId = null;
        let lastSavedBy = null;
        let cloudFileTimestamp = null;

        // Initialize cloud sync from localStorage
        function initializeCloudSync() {
            const savedToken = localStorage.getItem('cestisGoogleAccessToken');
            const savedExpiry = localStorage.getItem('cestisGoogleTokenExpiry');
            const savedLastSync = localStorage.getItem('cestisLastSyncTime');
            const savedFileId = localStorage.getItem('cestisCloudFileId');

            if (savedLastSync) {
                lastSyncTime = new Date(savedLastSync);
                updateLastSyncDisplay();
            }

            if (savedFileId) {
                cloudFileId = savedFileId;
            }

            // Check if token is still valid
            if (savedToken && savedExpiry) {
                const expiry = new Date(savedExpiry);
                if (expiry > new Date()) {
                    googleAccessToken = savedToken;
                    isCloudConnected = true;
                    updateCloudUI(true);
                    return;
                }
            }

            updateCloudUI(false);
        }

        // Update cloud UI based on connection status
        function updateCloudUI(connected) {
            const notConnectedDiv = document.getElementById('cloudNotConnected');
            const connectedDiv = document.getElementById('cloudConnected');
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');

            if (connected) {
                notConnectedDiv.style.display = 'none';
                connectedDiv.style.display = 'block';
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                notConnectedDiv.style.display = 'block';
                connectedDiv.style.display = 'none';
                statusDot.className = 'cloud-status-dot';
                statusText.textContent = 'Not connected';
            }
        }

        // Update syncing status
        function setCloudSyncing(syncing) {
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');
            const menuIcon = document.getElementById('cloudMenuIcon');

            if (syncing) {
                statusDot.className = 'cloud-status-dot syncing';
                statusText.textContent = 'Syncing...';
                menuIcon.innerHTML = '<span class="spinning"></span>';
            } else {
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
                menuIcon.textContent = '';
            }
        }

        // Toggle cloud dropdown menu
        function toggleCloudMenu() {
            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.toggle('show');

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCloudMenuOnClickOutside);
            }, 0);
        }

        function closeCloudMenuOnClickOutside(e) {
            const menu = document.getElementById('cloudDropdownMenu');
            const dropdown = document.querySelector('.cloud-dropdown');

            if (!dropdown.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeCloudMenuOnClickOutside);
            }
        }

        // Google Token Client for OAuth
        let googleTokenClient = null;

        // Initialize Google Identity Services
        function initGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                googleTokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                    scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                    callback: handleGoogleAuthCallback,
                    error_callback: handleGoogleAuthError
                });
            }
        }

        // Connect to Google Drive using OAuth
        async function connectToGoogleDrive() {
            // Always show the modal first - let user choose method
            showGoogleAuthModal();
        }

        // Show authentication modal with two options
        function showGoogleAuthModal() {
            const modalHTML = `
                <div id="googleAuthModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 560px;">
                        <div class="modal-header">
                            <h2> Connect to Google Drive</h2>
                            <button class="close-btn" onclick="closeGoogleAuthModal()"></button>
                        </div>
                        <div style="padding: var(--space-6);">
                            <p style="margin-bottom: var(--space-5); color: var(--text-secondary);">
                                Connect to Google Drive to save and sync your attendance data across devices. Choose your preferred connection method:
                            </p>

                            <!-- Option 1: Direct Google Sign-In (Recommended) -->
                            <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;"></span>
                                    <div>
                                        <strong style="color: var(--success); font-size: 1.1rem;">Direct Google Sign-In</strong>
                                        <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; margin-left: var(--space-2); font-weight: 600;">RECOMMENDED</span>
                                    </div>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    A Google popup will appear for you to sign in with your Google account directly.
                                </p>
                                <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width: 100%; padding: var(--space-3);">
                                    Sign in with Google
                                </button>
                            </div>

                            <!-- Option 2: Manual Token Method -->
                            <div id="manualTokenSection" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-5);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;"></span>
                                    <strong style="color: var(--text-primary); font-size: 1.1rem;">Manual Token Method</strong>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    If the popup doesn't work, you can still use the OAuth Playground to get a token manually.
                                </p>
                                <button class="btn btn-secondary" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width: 100%;">
                                    Use Manual Method
                                </button>

                                <!-- Manual token form (hidden by default) -->
                                <div id="manualTokenForm" style="display: none; margin-top: var(--space-4);">
                                    <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                                        <strong style="color: var(--info);">How to get your access token:</strong>
                                        <ol style="margin-top: var(--space-2); margin-left: var(--space-4); color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                                            <li>Click the link below to open Google OAuth Playground</li>
                                            <li>In Step 1, find and select <strong>"Drive API v3"</strong>  check <strong>"drive.file"</strong></li>
                                            <li>Click <strong>"Authorize APIs"</strong> (blue button)</li>
                                            <li>Sign in with your Google account</li>
                                            <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                            <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                                        </ol>
                                        <a href="https://developers.google.com/oauthplayground" target="_blank"
                                           style="display: inline-block; margin-top: var(--space-3); padding: var(--space-2) var(--space-4); background: var(--accent); color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; font-size: 0.875rem;">
                                             Open OAuth Playground
                                        </a>
                                    </div>

                                    <div class="form-group" style="margin-bottom: var(--space-4);">
                                        <label style="font-weight: 600;">Access Token</label>
                                        <textarea id="googleAccessTokenInput" rows="4" style="width: 100%; padding: var(--space-3); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; resize: vertical; margin-top: var(--space-2);" placeholder="Paste your access token here..."></textarea>
                                    </div>

                                    <button class="btn btn-success" onclick="submitGoogleToken()" style="width: 100%;">
                                         Connect with Token
                                    </button>
                                </div>
                            </div>

                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-secondary" onclick="closeGoogleAuthModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Trigger the direct Google Sign-In popup
        function triggerDirectGoogleSignIn() {
            closeGoogleAuthModal();
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                initGoogleAuth();
                setTimeout(() => {
                    if (googleTokenClient) {
                        googleTokenClient.requestAccessToken();
                    } else {
                        alert('Google Sign-In popup is not available. Please use the manual token method.');
                        showGoogleAuthModal();
                        // Auto-expand the manual form
                        setTimeout(() => showManualTokenForm(), 100);
                    }
                }, 500);
            }
        }

        // Show the manual token form
        function showManualTokenForm() {
            const form = document.getElementById('manualTokenForm');
            const btn = document.getElementById('showManualTokenBtn');
            if (form && btn) {
                form.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        function retryGoogleSignIn() {
            closeGoogleAuthModal();
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                initGoogleAuth();
                if (googleTokenClient) {
                    googleTokenClient.requestAccessToken();
                } else {
                    alert('Google Sign-In is not available. Please use the manual token method.');
                    showGoogleAuthModal();
                }
            }
        }

        function closeGoogleAuthModal() {
            const modal = document.getElementById('googleAuthModal');
            if (modal) modal.remove();
        }

        async function submitGoogleToken() {
            const tokenInput = document.getElementById('googleAccessTokenInput');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('Please enter an access token');
                return;
            }

            // Verify the token works by making a test API call
            try {
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }

                const data = await response.json();

                // Token is valid, save it
                googleAccessToken = token;
                isCloudConnected = true;

                // Save token with 1 hour expiry (typical for OAuth tokens)
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 1);
                localStorage.setItem('cestisGoogleAccessToken', token);
                localStorage.setItem('cestisGoogleTokenExpiry', expiry.toISOString());

                closeGoogleAuthModal();
                updateCloudUI(true);

                alert(` Connected to Google Drive as ${data.user.displayName || data.user.emailAddress}`);

                // Try to find existing backup file
                await findExistingBackupFile();

            } catch (error) {
                console.error('Token verification failed:', error);
                alert(' Invalid access token. Please make sure you copied the correct token.');
            }
        }

        async function handleGoogleAuthCallback(tokenResponse) {
            googleAccessToken = tokenResponse.access_token;
            isCloudConnected = true;

            const expiry = new Date();
            expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
            localStorage.setItem('cestisGoogleAccessToken', googleAccessToken);
            localStorage.setItem('cestisGoogleTokenExpiry', expiry.toISOString());

            updateCloudUI(true);

            // Try to find existing backup file
            await findExistingBackupFile();

            alert(' Connected to Google Drive successfully! You can now save and sync your data.');
        }

        function handleGoogleAuthError(error) {
            console.error('Google auth error:', error);
            if (error.type === 'popup_closed') {
                // User closed the popup, don't show error
                return;
            }
            alert('Failed to authenticate with Google. Please try the manual token method.');
            showGoogleAuthModal();
        }

        // Disconnect from Google Drive
        function disconnectFromGoogleDrive() {
            if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
                googleAccessToken = null;
                isCloudConnected = false;
                cloudFileId = null;

                localStorage.removeItem('cestisGoogleAccessToken');
                localStorage.removeItem('cestisGoogleTokenExpiry');
                localStorage.removeItem('cestisCloudFileId');

                updateCloudUI(false);
                toggleCloudMenu();

                alert(' Disconnected from Google Drive');
            }
        }

        // Find existing backup file in the folder
        async function findExistingBackupFile() {
            try {
                const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        cloudFileId = data.files[0].id;
                        localStorage.setItem('cestisCloudFileId', cloudFileId);
                        console.log('Found existing backup file:', cloudFileId);
                    }
                }
            } catch (error) {
                console.error('Error finding backup file:', error);
            }
        }

        // Check cloud file for changes before saving (multi-user conflict detection)
        async function checkCloudForChanges() {
            if (!cloudFileId || !googleAccessToken) return null;

            try {
                // Fetch the current cloud file to check who last saved and when
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const backupData = await response.json();
                    return {
                        savedBy: backupData.savedBy || 'Unknown',
                        timestamp: backupData.timestamp
                    };
                }
            } catch (error) {
                console.error('Error checking cloud for changes:', error);
            }
            return null;
        }

        // Save data to Google Drive
        async function saveToCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // Check for changes by others before saving
            const cloudInfo = await checkCloudForChanges();

            let confirmMessage = ' MULTI-USER CLOUD SYNC\n\n';
            confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

            if (cloudInfo && cloudInfo.savedBy) {
                const cloudTime = new Date(cloudInfo.timestamp);
                const timeSinceLastSave = getTimeAgo(cloudTime);

                // Check if someone else saved since our last sync
                const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

                if (hasConflict && cloudInfo.savedBy !== (currentUser ? currentUser.username : '')) {
                    confirmMessage += ` WARNING: ${cloudInfo.savedBy} saved changes ${timeSinceLastSave}!\n`;
                    confirmMessage += `Your local data may not include their changes.\n\n`;
                    confirmMessage += ` Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n`;
                } else {
                    confirmMessage += `Last saved by: ${cloudInfo.savedBy} (${timeSinceLastSave})\n\n`;
                }
            }

            confirmMessage += 'This will overwrite the cloud backup. Continue?';

            if (!confirm(confirmMessage)) {
                return;
            }

            setCloudSyncing(true);

            try {
                // Prepare data for backup
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    savedBy: currentUser ? currentUser.username : 'Unknown',
                    data: {
                        users: users,
                        students: students,
                        attendanceRecords: attendanceRecords,
                        skills: skills
                    }
                };

                const jsonContent = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });

                let response;

                if (cloudFileId) {
                    // Update existing file
                    response = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: blob
                        }
                    );
                } else {
                    // Create new file with metadata
                    const metadata = {
                        name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                        parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                        mimeType: 'application/json'
                    };

                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append('file', blob);

                    response = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`
                            },
                            body: formData
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        cloudFileId = result.id;
                        localStorage.setItem('cestisCloudFileId', cloudFileId);
                    }
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Upload failed');
                }

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('cestisLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = currentUser ? currentUser.username : 'Unknown';
                cloudFileTimestamp = new Date().toISOString();
                updateLastSavedByDisplay();

                setCloudSyncing(false);
                alert(` Data saved to Google Drive successfully!\n\nSaved by: ${lastSavedBy}\n\n Tip: Let other users know to sync from cloud to get your changes.`);

            } catch (error) {
                console.error('Error saving to cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert(' Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(` Failed to save to cloud: ${error.message}`);
                }
            }
        }

        // Sync (download) data from Google Drive
        async function syncFromCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // First try to find the file if we don't have the ID
            if (!cloudFileId) {
                await findExistingBackupFile();
            }

            if (!cloudFileId) {
                alert(' No backup file found in Google Drive. Save your data first to create a backup.');
                return;
            }

            if (!confirm(' This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
                return;
            }

            setCloudSyncing(true);

            try {
                // Download the file
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download backup');
                }

                const backupData = await response.json();

                // Validate backup format
                if (!backupData.data || !backupData.version) {
                    throw new Error('Invalid backup file format');
                }

                // Restore data
                if (backupData.data.users) {
                    users = backupData.data.users;
                    saveUsers();
                }

                if (backupData.data.students) {
                    students = backupData.data.students;
                    saveStudents();
                }

                if (backupData.data.attendanceRecords) {
                    attendanceRecords = backupData.data.attendanceRecords;
                    saveAttendanceRecords();
                }

                if (backupData.data.skills) {
                    skills = backupData.data.skills;
                    saveSkills();
                }

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('cestisLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Refresh UI
                populateSkillDropdowns();
                if (currentUser && currentUser.role === 'Admin') {
                    renderSkillsTable();
                    renderStudentsTable();
                    renderUsersTable();
                }
                renderTodayAttendance();

                setCloudSyncing(false);

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                const backupTime = new Date(backupData.timestamp).toLocaleString();
                const savedByInfo = backupData.savedBy ? `\nLast saved by: ${backupData.savedBy}` : '';
                alert(` Data synced from cloud successfully!\n\nBackup was created: ${backupTime}${savedByInfo}`);

            } catch (error) {
                console.error('Error syncing from cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert(' Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(` Failed to sync from cloud: ${error.message}`);
                }
            }
        }

        // Update last sync display
        function updateLastSyncDisplay() {
            const lastSyncInfo = document.getElementById('lastSyncInfo');
            if (lastSyncTime) {
                const timeAgo = getTimeAgo(lastSyncTime);
                lastSyncInfo.textContent = `Last sync: ${timeAgo}`;
            } else {
                lastSyncInfo.textContent = 'Last sync: Never';
            }
        }

        // Update last saved by display
        function updateLastSavedByDisplay() {
            const lastSavedByInfo = document.getElementById('lastSavedByInfo');
            if (lastSavedByInfo) {
                if (lastSavedBy && cloudFileTimestamp) {
                    const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy} (${timeAgo})`;
                } else if (lastSavedBy) {
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy}`;
                } else {
                    lastSavedByInfo.textContent = 'Last saved by: --';
                }
            }
        }

        // Get human-readable time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultData();

            // Check session
            const savedUser = sessionStorage.getItem('cestisAttendanceCurrentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = ` ${currentUser.fullName} (${currentUser.role})`;
                updateUIForRole();
                populateSkillDropdowns();
                renderTodayAttendance();
            }

            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('historyToDate').value = today;
            document.getElementById('reportToDate').value = today;

            // Set week ago
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('historyFromDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('reportFromDate').value = weekAgo.toISOString().split('T')[0];

            // Dark mode
            const isDark = localStorage.getItem('cestisAttendanceDarkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = '';
                document.getElementById('themeText').textContent = 'Light';
            }

            // Initialize cloud sync
            initializeCloudSync();

            // Initialize Google Auth after a short delay to ensure GIS library is loaded
            setTimeout(() => {
                initGoogleAuth();
            }, 500);

            // 2FA input event listeners
            const twoFAInputs = ['login2FACode', 'twofaSetupCode', 'twofaDisableCode'];
            twoFAInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Only allow numeric input
                    input.addEventListener('input', function(e) {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });

                    // Handle Enter key
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (inputId === 'login2FACode') verify2FALogin();
                            else if (inputId === 'twofaSetupCode') confirmTwoFASetup();
                            else if (inputId === 'twofaDisableCode') confirmTwoFADisable();
                        }
                    });
                }
            });

            // Backup code input - allow alphanumeric, convert to uppercase
            const backupCodeInput = document.getElementById('loginBackupCode');
            if (backupCodeInput) {
                backupCodeInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                });
                backupCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyBackupCodeLogin();
                    }
                });
            }
        });
    </script>
</body>
</html>
